<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compound — Idle Empire</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b0f14; color: #e8eef7;
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .top {
      display: flex; align-items: baseline; justify-content: space-between; gap: 12px; flex-wrap: wrap;
      border-bottom: 1px solid rgba(255,255,255,.12); padding-bottom: 12px; margin-bottom: 14px;
    }
    h1 { font-size: 18px; margin: 0; letter-spacing: .4px; }
    .sub { opacity: .75; font-size: 12px; }
    .grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 820px) { .grid { grid-template-columns: 1.2fr .8fr; } }
    .card {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .statRow { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
    .stat {
      padding: 12px; border-radius: 12px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.08);
    }
    .label { font-size: 11px; opacity: .7; margin-bottom: 6px; }
    .value { font-size: 18px; font-weight: 700; }
    .mono { font-variant-numeric: tabular-nums; }
    .btnRow { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button {
      appearance: none; border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06); color: #e8eef7;
      padding: 10px 12px; border-radius: 12px; cursor: pointer;
      font-weight: 650;
    }
    button:hover { background: rgba(255,255,255,.10); }
    button.primary { background: rgba(120,180,255,.18); border-color: rgba(120,180,255,.35); }
    button.gold { background: rgba(255,210,120,.14); border-color: rgba(255,210,120,.30); }
    button.danger { background: rgba(255,100,120,.14); border-color: rgba(255,100,120,.28); }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .small { font-size: 12px; opacity: .8; line-height: 1.35; }
    .hr { height: 1px; background: rgba(255,255,255,.10); margin: 12px 0; }
    .list { display: grid; gap: 10px; margin-top: 12px; }
    .item { display: grid; gap: 6px; padding: 10px; border-radius: 12px; background: rgba(0,0,0,.22); border: 1px solid rgba(255,255,255,.08); }
    .itemTop { display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap; align-items: center; }
    .pill { font-size: 11px; opacity: .75; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); }
    .locked {
      opacity: .55;
      filter: saturate(.6);
    }
    .lockNote {
      font-size: 12px;
      opacity: .75;
    }
    footer { margin-top: 18px; opacity: .65; font-size: 11px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Compound</h1>
        <div class="sub">Idle empire MVP — upgrades + prestige + gating</div>
      </div>
      <div class="sub" id="status">Loading…</div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="statRow">
          <div class="stat">
            <div class="label">Cash</div>
            <div class="value mono" id="cash">$0</div>
          </div>
          <div class="stat">
            <div class="label">Income / sec</div>
            <div class="value mono" id="ips">$0</div>
          </div>
        </div>

        <div class="statRow" style="margin-top:10px;">
          <div class="stat">
            <div class="label">Operations Multiplier</div>
            <div class="value mono" id="opsMult">x1.00</div>
          </div>
          <div class="stat">
            <div class="label">Prestige Multiplier</div>
            <div class="value mono" id="prestMult">x1.00</div>
          </div>
        </div>

        <div class="statRow" style="margin-top:10px;">
          <div class="stat">
            <div class="label">Equity Points (EP)</div>
            <div class="value mono" id="ep">0</div>
          </div>
          <div class="stat">
            <div class="label">Lifetime Earned</div>
            <div class="value mono" id="lifetime">$0</div>
          </div>
        </div>

        <div class="btnRow">
          <button class="primary" id="workBtn">Do Work (+$1)</button>
          <button id="saveBtn">Save</button>
          <button class="danger" id="resetBtn">Hard Reset</button>
        </div>

        <div class="hr"></div>

        <div class="item">
          <div class="itemTop">
            <div style="font-weight:800;">Prestige: Exit & Reinvest</div>
            <div class="pill mono" id="prestReq">$10.00K goal</div>
          </div>
          <div class="small" id="prestHint">
            Reach the goal to unlock Prestige. Prestige resets your run but increases your permanent multiplier.
          </div>
          <div class="btnRow" style="margin-top:10px;">
            <button class="gold" id="prestigeBtn" disabled>Prestige (Locked)</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="small">
          Upgrade unlock order is now enforced so the game teaches itself.
        </div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div>
            <div style="font-weight:750;">Upgrades</div>
            <div class="sub">Unlock in order (less overwhelm)</div>
          </div>
          <div class="pill mono" id="ownedPill">Owned: 0</div>
        </div>

        <div class="list">
          <!-- Assistant (always available) -->
          <div class="item" id="rowAssistant">
            <div class="itemTop">
              <div style="font-weight:700;">Hire an Assistant</div>
              <div class="pill mono" id="assistantCost">$25</div>
            </div>
            <div class="small">+ $1.00 base income/sec per purchase. Price grows each time.</div>
            <button id="buyAssistantBtn">Buy</button>
          </div>

          <!-- Tools (requires 1 assistant) -->
          <div class="item locked" id="rowTools">
            <div class="itemTop">
              <div style="font-weight:700;">Buy Better Tools</div>
              <div class="pill mono" id="toolsCost">$60</div>
            </div>
            <div class="small">Multiply income by ×1.25 per purchase. Price grows each time.</div>
            <div class="lockNote" id="toolsLockNote">Locked: hire 1 assistant</div>
            <button id="buyToolsBtn" disabled>Locked</button>
          </div>

          <!-- Processes (requires 2 tools) -->
          <div class="item locked" id="rowProc">
            <div class="itemTop">
              <div style="font-weight:700;">Standardize Processes</div>
              <div class="pill mono" id="procCost">$150</div>
            </div>
            <div class="small">Multiply income by ×1.40 per purchase. Price grows each time.</div>
            <div class="lockNote" id="procLockNote">Locked: buy 2 tools</div>
            <button id="buyProcBtn" disabled>Locked</button>
          </div>

          <!-- Automation (requires 1 process) -->
          <div class="item locked" id="rowAuto">
            <div class="itemTop">
              <div style="font-weight:700;">Basic Automation</div>
              <div class="pill mono" id="autoCost">$400</div>
            </div>
            <div class="small">Multiply income by ×2.00 per purchase. Price grows each time.</div>
            <div class="lockNote" id="autoLockNote">Locked: buy 1 process</div>
            <button id="buyAutoBtn" disabled>Locked</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="small">
          Offline gains are capped at 6 hours (v0). Everything saves automatically.
        </div>
      </div>
    </div>

    <footer>
      Single-file GitHub Pages MVP. Next: tiny visual panel (office grows) if you want.
    </footer>
  </div>

  <script>
    // ---------- Compound v0.3 (single-file) ----------
    const KEY = "compound_idle_v0_3";

    const state = {
      cash: 0,
      lastTickMs: Date.now(),
      lastSaveMs: Date.now(),
      lifetimeEarned: 0,

      ep: 0,
      prestigeCount: 0,

      owned: { assistant: 0, tools: 0, proc: 0, auto: 0 },

      assistantCost: 25,
      toolsCost: 60,
      procCost: 150,
      autoCost: 400
    };

    // helpers
    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    function money(n) {
      const abs = Math.abs(n);
      if (abs >= 1e9) return "$" + (n/1e9).toFixed(2) + "B";
      if (abs >= 1e6) return "$" + (n/1e6).toFixed(2) + "M";
      if (abs >= 1e3) return "$" + (n/1e3).toFixed(2) + "K";
      return "$" + n.toFixed(2);
    }

    function fmtX(n) { return "x" + n.toFixed(2); }

    function setStatus(msg) {
      const el = document.getElementById("status");
      el.textContent = msg;
      clearTimeout(setStatus._t);
      setStatus._t = setTimeout(() => {
        if (el.textContent === msg) el.textContent = "Ready";
      }, 1200);
    }

    function safeMerge() {
      state.owned = Object.assign({ assistant:0, tools:0, proc:0, auto:0 }, state.owned || {});
      if (typeof state.ep !== "number") state.ep = 0;
      if (typeof state.prestigeCount !== "number") state.prestigeCount = 0;
    }

    function save(silent=false) {
      state.lastSaveMs = Date.now();
      localStorage.setItem(KEY, JSON.stringify(state));
      if (!silent) setStatus("Saved");
    }

    function load() {
      const raw = localStorage.getItem(KEY);
      if (!raw) return false;
      try {
        const data = JSON.parse(raw);
        Object.assign(state, data);
        safeMerge();
        return true;
      } catch {
        return false;
      }
    }

    function hardReset() {
      localStorage.removeItem(KEY);
      location.reload();
    }

    // economics
    function opsMultiplier() {
      const toolsMult = Math.pow(1.25, state.owned.tools || 0);
      const procMult  = Math.pow(1.40, state.owned.proc  || 0);
      const autoMult  = Math.pow(2.00, state.owned.auto  || 0);
      return toolsMult * procMult * autoMult;
    }

    function prestigeMultiplier() {
      return Math.pow(1.2, state.ep || 0);
    }

    function baseIncomePerSecond() {
      return (state.owned.assistant || 0) * 1.0;
    }

    function incomePerSecond() {
      return baseIncomePerSecond() * opsMultiplier() * prestigeMultiplier();
    }

    // gating rules
    function unlockedTools() { return (state.owned.assistant || 0) >= 1; }
    function unlockedProc()  { return (state.owned.tools || 0) >= 2; }
    function unlockedAuto()  { return (state.owned.proc || 0) >= 1; }

    // Prestige
    const PRESTIGE_GOAL = 10000;

    function canPrestige() { return (state.cash || 0) >= PRESTIGE_GOAL; }

    function epGainIfPrestigeNow() {
      const le = Math.max(0, state.lifetimeEarned || 0) + 1;
      return Math.max(1, Math.floor(Math.log10(le)));
    }

    function doPrestige() {
      if (!canPrestige()) return;

      const gain = epGainIfPrestigeNow();
      state.ep = (state.ep || 0) + gain;
      state.prestigeCount = (state.prestigeCount || 0) + 1;

      // reset run (keep EP)
      state.cash = 0;
      state.lastTickMs = Date.now();
      state.lastSaveMs = Date.now();
      state.lifetimeEarned = 0;

      state.owned = { assistant: 0, tools: 0, proc: 0, auto: 0 };
      state.assistantCost = 25;
      state.toolsCost = 60;
      state.procCost = 150;
      state.autoCost = 400;

      save(true);
      setStatus(`Prestiged: +${gain} EP`);
      render();
    }

    function applyOfflineProgress() {
      const now = Date.now();
      const secondsAway = (now - (state.lastTickMs || now)) / 1000;
      const capped = clamp(secondsAway, 0, 6 * 3600);
      const earned = incomePerSecond() * capped;

      if (earned > 0.01) {
        state.cash += earned;
        state.lifetimeEarned += earned;
        setStatus(`Offline: +${money(earned)}`);
      } else {
        setStatus("Ready");
      }
      state.lastTickMs = now;
    }

    // UI refs
    const $cash = document.getElementById("cash");
    const $ips = document.getElementById("ips");
    const $opsMult = document.getElementById("opsMult");
    const $prestMult = document.getElementById("prestMult");
    const $ep = document.getElementById("ep");
    const $lifetime = document.getElementById("lifetime");
    const $ownedPill = document.getElementById("ownedPill");

    const $assistantCost = document.getElementById("assistantCost");
    const $toolsCost = document.getElementById("toolsCost");
    const $procCost = document.getElementById("procCost");
    const $autoCost = document.getElementById("autoCost");

    const $buyAssistantBtn = document.getElementById("buyAssistantBtn");
    const $buyToolsBtn = document.getElementById("buyToolsBtn");
    const $buyProcBtn = document.getElementById("buyProcBtn");
    const $buyAutoBtn = document.getElementById("buyAutoBtn");

    const $rowTools = document.getElementById("rowTools");
    const $rowProc = document.getElementById("rowProc");
    const $rowAuto = document.getElementById("rowAuto");

    const $toolsLockNote = document.getElementById("toolsLockNote");
    const $procLockNote = document.getElementById("procLockNote");
    const $autoLockNote = document.getElementById("autoLockNote");

    const $prestigeBtn = document.getElementById("prestigeBtn");
    const $prestReq = document.getElementById("prestReq");
    const $prestHint = document.getElementById("prestHint");

    function totalOwned() {
      return (state.owned.assistant||0) + (state.owned.tools||0) + (state.owned.proc||0) + (state.owned.auto||0);
    }

    function setRowLocked(rowEl, btnEl, noteEl, locked, noteText, canBuy) {
      if (locked) {
        rowEl.classList.add("locked");
        btnEl.disabled = true;
        btnEl.textContent = "Locked";
        noteEl.textContent = noteText;
        noteEl.style.display = "block";
      } else {
        rowEl.classList.remove("locked");
        noteEl.style.display = "none";
        btnEl.disabled = !canBuy;
        btnEl.textContent = canBuy ? "Buy" : "Need more cash";
      }
    }

    function render() {
      $cash.textContent = money(state.cash || 0);
      $ips.textContent = money(incomePerSecond()) + "/s";
      $opsMult.textContent = fmtX(opsMultiplier());
      $prestMult.textContent = fmtX(prestigeMultiplier());
      $ep.textContent = String(state.ep || 0);
      $lifetime.textContent = money(state.lifetimeEarned || 0);
      $ownedPill.textContent = "Owned: " + totalOwned();

      $assistantCost.textContent = money(state.assistantCost);
      $toolsCost.textContent = money(state.toolsCost);
      $procCost.textContent = money(state.procCost);
      $autoCost.textContent = money(state.autoCost);

      // Assistant always available
      $buyAssistantBtn.disabled = (state.cash || 0) < state.assistantCost;
      $buyAssistantBtn.textContent = ((state.cash || 0) < state.assistantCost) ? "Need more cash" : "Buy";

      // Gated upgrades
      const toolsUnlocked = unlockedTools();
      const procUnlocked = unlockedProc();
      const autoUnlocked = unlockedAuto();

      setRowLocked(
        $rowTools, $buyToolsBtn, $toolsLockNote,
        !toolsUnlocked,
        "Locked: hire 1 assistant",
        (state.cash || 0) >= state.toolsCost
      );

      setRowLocked(
        $rowProc, $buyProcBtn, $procLockNote,
        !procUnlocked,
        "Locked: buy 2 tools",
        (state.cash || 0) >= state.procCost
      );

      setRowLocked(
        $rowAuto, $buyAutoBtn, $autoLockNote,
        !autoUnlocked,
        "Locked: buy 1 process",
        (state.cash || 0) >= state.autoCost
      );

      // Prestige UI
      $prestReq.textContent = money(PRESTIGE_GOAL) + " goal";
      const ok = canPrestige();
      $prestigeBtn.disabled = !ok;
      $prestigeBtn.textContent = ok ? `Prestige (+${epGainIfPrestigeNow()} EP)` : "Prestige (Locked)";
      $prestHint.textContent = ok
        ? "Ready. This will reset your upgrades and cash, but permanently increase your multiplier."
        : `Locked until Cash ≥ ${money(PRESTIGE_GOAL)}. Current EP gain if you prestige: +${epGainIfPrestigeNow()}.`;
    }

    function tick() {
      const now = Date.now();
      const dt = (now - state.lastTickMs) / 1000;
      state.lastTickMs = now;

      const earned = incomePerSecond() * dt;
      if (earned > 0) {
        state.cash += earned;
        state.lifetimeEarned += earned;
      }

      if (now - state.lastSaveMs > 10000) save(true);
      render();
    }

    // actions
    document.getElementById("workBtn").addEventListener("click", () => {
      state.cash += 1;
      state.lifetimeEarned += 1;
      render();
    });

    document.getElementById("saveBtn").addEventListener("click", () => save(false));
    document.getElementById("resetBtn").addEventListener("click", hardReset);
    document.getElementById("prestigeBtn").addEventListener("click", doPrestige);

    $buyAssistantBtn.addEventListener("click", () => {
      if ((state.cash || 0) < state.assistantCost) return;
      state.cash -= state.assistantCost;
      state.owned.assistant = (state.owned.assistant || 0) + 1;
      state.assistantCost = Math.ceil(state.assistantCost * 1.35);
      setStatus("Assistant hired");
      render();
    });

    $buyToolsBtn.addEventListener("click", () => {
      if (!unlockedTools()) return;
      if ((state.cash || 0) < state.toolsCost) return;
      state.cash -= state.toolsCost;
      state.owned.tools = (state.owned.tools || 0) + 1;
      state.toolsCost = Math.ceil(state.toolsCost * 1.45);
      setStatus("Tools upgraded");
      render();
    });

    $buyProcBtn.addEventListener("click", () => {
      if (!unlockedProc()) return;
      if ((state.cash || 0) < state.procCost) return;
      state.cash -= state.procCost;
      state.owned.proc = (state.owned.proc || 0) + 1;
      state.procCost = Math.ceil(state.procCost * 1.55);
      setStatus("Processes standardized");
      render();
    });

    $buyAutoBtn.addEventListener("click", () => {
      if (!unlockedAuto()) return;
      if ((state.cash || 0) < state.autoCost) return;
      state.cash -= state.autoCost;
      state.owned.auto = (state.owned.auto || 0) + 1;
      state.autoCost = Math.ceil(state.autoCost * 1.70);
      setStatus("Automation installed");
      render();
    });

    // boot
    const hadSave = load();
    safeMerge();
    applyOfflineProgress();
    render();
    setStatus(hadSave ? "Loaded" : "New run");
    setInterval(tick, 100);
  </script>
</body>
</html>

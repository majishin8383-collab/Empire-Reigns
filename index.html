<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Empire Reigns — Cozy Idle</title>
  <style>
    :root{
      color-scheme: dark;
      --ink: #f3f1ea;
      --muted: rgba(243,241,234,.78);
      --line: rgba(255,255,255,.14);
      --panel: rgba(12,10,14,.44);
      --panel2: rgba(12,10,14,.34);
      --glass: blur(10px);

      /* cozy accents */
      --cream: rgba(255,245,220,.16);
      --gold: rgba(255,210,120,.18);
      --sky: rgba(120,180,255,.14);
      --mint: rgba(120,220,180,.14);
      --pink: rgba(255,140,170,.14);
      --shadow: rgba(0,0,0,.48);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: #07080c;
      color: var(--ink);
      overflow-x: hidden;
    }

    /* ===== WORLD ===== */
    .world{
      min-height:100vh;
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(255,235,190,.12), transparent 60%),
        radial-gradient(840px 520px at 80% 15%, rgba(160,210,255,.14), transparent 62%),
        linear-gradient(180deg, rgba(10,12,18,1) 0%, rgba(8,10,14,1) 45%, rgba(6,8,10,1) 100%);
    }

    /* Cozy vignette + grain */
    .vignette{
      pointer-events:none;
      position:absolute; inset:-2px;
      background:
        radial-gradient(1200px 780px at 50% 35%, transparent 55%, rgba(0,0,0,.55) 100%);
      opacity:.7;
      z-index: 9;
      mix-blend-mode: multiply;
    }
    .grain{
      pointer-events:none;
      position:absolute; inset:-2px;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.12'/%3E%3C/svg%3E");
      opacity:.18;
      z-index: 10;
      mix-blend-mode: overlay;
    }

    .layer{ position:absolute; left:0; right:0; }

    /* SVG scene container */
    .scene{
      position:absolute;
      left:50%;
      top:0;
      width:min(1400px, 140vw);
      transform: translateX(-50%);
      height: 72vh;
      z-index: 4;
      pointer-events:none;
      filter: drop-shadow(0 30px 70px rgba(0,0,0,.35));
    }

    /* Ground band (where interactive town sits) */
    .groundBand{
      position:absolute;
      left:0; right:0;
      top: 60vh;
      bottom: 0;
      z-index: 5;
      background:
        radial-gradient(900px 220px at 50% 0%, rgba(255,255,255,.06), transparent 62%),
        linear-gradient(180deg, rgba(35,50,38,.55), rgba(12,18,14,.92));
      border-top: 1px solid rgba(255,255,255,.06);
    }

    .road{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top: 64vh;
      width:min(680px, 92vw);
      height: 160px;
      border-radius: 30px;
      z-index: 6;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.28)),
        linear-gradient(90deg, rgba(0,0,0,.58), rgba(0,0,0,.28));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 30px 90px rgba(0,0,0,.45);
    }
    .road:before{
      content:"";
      position:absolute; left: 10%; right: 10%; top: 52%;
      height: 7px; transform: translateY(-50%);
      background: repeating-linear-gradient(90deg, rgba(255,225,155,.25) 0 18px, transparent 18px 38px);
      opacity: .75;
      border-radius: 999px;
      filter: blur(.2px);
    }

    /* ===== HUD ===== */
    .hud{
      position: sticky;
      top:0;
      z-index: 60;
      background: rgba(10,10,14,.62);
      backdrop-filter: var(--glass);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .hudInner{
      max-width: 1120px;
      margin: 0 auto;
      padding: 10px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:baseline;
      gap: 10px;
    }
    .brand h1{
      margin:0;
      font-size: 16px;
      letter-spacing:.4px;
    }
    .brand .sub{
      font-size: 12px;
      opacity:.78;
    }

    .hudStats{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .pillHud{
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      min-width: 120px;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .pillHud .k{ font-size:10px; opacity:.75; }
    .pillHud .v{ font-size:14px; font-weight: 950; font-variant-numeric: tabular-nums; }

    /* ===== PANELS ===== */
    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 18px 16px;
      position: relative;
      z-index: 40;
    }

    .panel{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(10,10,14,.50);
      backdrop-filter: var(--glass);
      box-shadow: 0 30px 110px rgba(0,0,0,.55);
      overflow:hidden;
    }

    .tabs{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      padding: 10px;
      background: rgba(255,255,255,.03);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }

    .tabBtn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--ink);
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 950;
      font-size: 12px;
      letter-spacing:.2px;
      transition: transform .06s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .tabBtn:hover{ background: rgba(255,255,255,.08); }
    .tabBtn:active{ transform: translateY(1px); }
    .tabBtn.active{
      background: linear-gradient(180deg, rgba(255,210,120,.16), rgba(120,180,255,.10));
      border-color: rgba(255,210,120,.26);
      box-shadow: 0 0 0 1px rgba(255,210,120,.10), 0 0 18px rgba(255,210,120,.10);
    }

    .panelInner{ padding: 14px; }
    .grid{
      display:grid;
      gap: 12px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 960px){
      .grid{ grid-template-columns: 1.2fr .8fr; }
    }

    .item{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.18));
      padding: 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }

    .itemTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }

    .hr{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 12px 0;
    }

    .small{ font-size: 12px; opacity:.85; line-height:1.35; }
    .mono{ font-variant-numeric: tabular-nums; }

    .pill{
      font-size: 11px;
      opacity:.8;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }

    /* Buttons */
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 16px;
      cursor:pointer;
      font-weight: 950;
      letter-spacing:.1px;
      transition: transform .06s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease, filter .12s ease;
      user-select: none;
    }
    button:hover{
      background:
        linear-gradient(180deg, rgba(255,255,255,.09), rgba(0,0,0,.18));
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    button.primary{
      background: linear-gradient(180deg, rgba(120,180,255,.22), rgba(0,0,0,.18));
      border-color: rgba(120,180,255,.30);
      box-shadow: 0 0 0 1px rgba(120,180,255,.10), 0 12px 30px rgba(0,0,0,.18);
    }
    button.gold{
      background: linear-gradient(180deg, rgba(255,210,120,.20), rgba(0,0,0,.18));
      border-color: rgba(255,210,120,.28);
      box-shadow: 0 0 0 1px rgba(255,210,120,.10), 0 12px 30px rgba(0,0,0,.18);
    }
    button.danger{
      background: linear-gradient(180deg, rgba(255,140,170,.18), rgba(0,0,0,.18));
      border-color: rgba(255,140,170,.26);
    }

    .canBuy{
      box-shadow: 0 0 0 1px rgba(255,210,120,.12), 0 0 22px rgba(255,210,120,.10);
      border-color: rgba(255,210,120,.30) !important;
      filter: saturate(1.04);
    }

    .locked{ opacity:.64; filter:saturate(.8); }

    /* Floater */
    .floater{
      position: fixed; pointer-events:none; z-index: 999;
      font-weight: 950; font-size: 12px; opacity: .95;
      transform: translate(-50%, -50%);
      animation: floatUp .55s ease forwards;
      text-shadow: 0 10px 26px rgba(0,0,0,.65);
      font-variant-numeric: tabular-nums;
    }
    @keyframes floatUp{
      from{ opacity:.98; transform: translate(-50%, -50%) translateY(0); }
      to{ opacity:0; transform: translate(-50%, -50%) translateY(-26px); }
    }

    /* ===== BOTTOM NAV ===== */
    .bottomNav{
      position: fixed; left: 0; right: 0; bottom: 0;
      z-index: 70;
      background: rgba(10,10,14,.70);
      backdrop-filter: var(--glass);
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .bottomInner{
      max-width: 1120px; margin: 0 auto; padding: 10px 12px;
      display:flex; gap:10px; justify-content:space-between; align-items:center;
    }
    .navBtn{
      flex:1;
      display:flex; flex-direction:column; gap:2px;
      align-items:center; justify-content:center;
      padding: 10px 8px;
      border-radius: 16px;
      font-size: 12px;
    }
    .navBtn .k{ font-size:10px; opacity:.7; font-weight:850; }
    .navBtn.active{
      background: linear-gradient(180deg, rgba(255,210,120,.14), rgba(120,180,255,.10));
      border-color: rgba(255,210,120,.26);
      box-shadow: 0 0 0 1px rgba(255,210,120,.10);
    }
    .padBottom{ height: 90px; }

    /* ===== INTERACTIVE BUILDINGS (now: “illustrated” SVG style) ===== */
    .buildings{
      position:absolute; left:0; right:0; top:0; bottom:0;
      z-index: 55;
      pointer-events:none;
    }
    .building{
      pointer-events:auto;
      position:absolute;
      width: 190px; height: 160px;
      cursor:pointer;
      user-select:none;
      transform-origin: center bottom;
      transition: transform .08s ease, filter .12s ease;
      filter: drop-shadow(0 18px 26px rgba(0,0,0,.34));
    }
    .building:hover{ transform: translateY(-2px) scale(1.01); }
    .building:active{ transform: translateY(0px) scale(.99); }

    /* positions */
    .b-office    { left: 7vw;  top: 56vh; }
    .b-warehouse { left: 30vw; top: 58vh; }
    .b-garage    { left: 54vw; top: 58vh; }
    .b-shop      { left: 77vw; top: 56vh; }

    @media (max-width: 560px){
      .building{ width: 150px; height: 132px; }
      .b-office{ left: 2vw; }
      .b-warehouse{ left: 26vw; }
      .b-garage{ left: 50vw; }
      .b-shop{ left: 72vw; }
    }

    @keyframes glowPulse{
      0% { filter: drop-shadow(0 18px 26px rgba(0,0,0,.34)) drop-shadow(0 0 0 rgba(255,210,120,0)); }
      70%{ filter: drop-shadow(0 18px 26px rgba(0,0,0,.34)) drop-shadow(0 0 22px rgba(255,210,120,.16)); }
      100%{ filter: drop-shadow(0 18px 26px rgba(0,0,0,.34)) drop-shadow(0 0 0 rgba(255,210,120,0)); }
    }
    .building.canBuy{ animation: glowPulse 1.35s ease-in-out infinite; }

    /* level visibility */
    .lvl2, .lvl3, .lvl4{ display:none; }
    .building[data-lvl="2"] .lvl2{ display:block; }
    .building[data-lvl="3"] .lvl2, .building[data-lvl="3"] .lvl3{ display:block; }
    .building[data-lvl="4"] .lvl2, .building[data-lvl="4"] .lvl3, .building[data-lvl="4"] .lvl4{ display:block; }

    /* ===== PEOPLE (cuter) ===== */
    .people{
      position:absolute;
      left: 7vw;
      top: 67vh;
      width: 250px;
      height: 80px;
      z-index: 56;
      pointer-events:none;
      display:flex;
      gap: 6px;
      align-items:flex-end;
      flex-wrap:wrap;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.32));
    }
    @media (max-width:560px){
      .people{ left: 2vw; width: 200px; top: 68vh; }
    }
    .person{
      width: 18px; height: 36px;
      border-radius: 999px;
      position: relative;
      opacity: .98;
      animation: personBob 1.9s ease-in-out infinite;
      will-change: transform;
    }
    .person:nth-child(2n){ animation-delay:.25s; }
    .person:nth-child(3n){ animation-delay:.55s; }
    .person:nth-child(5n){ animation-delay:.85s; }
    @keyframes personBob{ 0%,100%{ transform: translateY(0);} 50%{ transform: translateY(-2px);} }

    .person:before{
      content:"";
      position:absolute;
      left:50%; top:1px;
      width: 14px; height: 14px;
      transform: translateX(-50%);
      border-radius: 999px;
      background: rgba(255,245,220,.14);
      border: 1px solid rgba(255,245,220,.22);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }
    .person:after{
      content:"";
      position:absolute;
      left:50%; bottom:0;
      width: 18px; height: 22px;
      transform: translateX(-50%);
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(120,180,255,.18), rgba(0,0,0,.10));
      border: 1px solid rgba(120,180,255,.22);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }

    /* ===== Speech bubble ===== */
    .bubble{
      position:absolute;
      z-index: 90;
      width: min(360px, 88vw);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(12,10,14,.62);
      backdrop-filter: var(--glass);
      box-shadow: 0 40px 120px rgba(0,0,0,.65);
      display:none;
      overflow:hidden;
    }
    .bubble:after{
      content:"";
      position:absolute;
      width: 14px; height: 14px;
      background: rgba(12,10,14,.62);
      border-left: 1px solid rgba(255,255,255,.14);
      border-bottom: 1px solid rgba(255,255,255,.14);
      transform: rotate(45deg);
      left: var(--tailX, 28px);
      bottom: -7px;
    }
    .bubbleHeader{
      padding: 10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .bubbleHeader .title{ font-weight: 950; letter-spacing:.2px; }
    .bubbleBody{ padding: 12px; display:grid; gap: 10px; }
    .bubbleRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .bubbleClose{ padding: 8px 10px; border-radius: 14px; font-size: 12px; font-weight: 950; }

    .backdropClickCatcher{
      position:absolute;
      inset:0;
      z-index: 80;
      display:none;
      background: transparent;
    }

    /* ===== Level-up FX (keep) ===== */
    .fxBurst{ position: fixed; left:0; top:0; width:0; height:0; pointer-events:none; z-index: 2000; }
    .fxParticle{
      position:absolute; width: 6px; height: 6px; border-radius: 999px;
      background: rgba(255,210,120,.88);
      box-shadow: 0 0 12px rgba(255,210,120,.20);
      transform: translate(-50%, -50%);
      animation: fxPop .65s ease-out forwards;
    }
    .fxParticle.blue{
      background: rgba(120,180,255,.88);
      box-shadow: 0 0 12px rgba(120,180,255,.20);
    }
    @keyframes fxPop{
      from{ opacity: 1; transform: translate(-50%, -50%) translate(0,0) scale(1); }
      to{ opacity: 0; transform: translate(-50%, -50%) translate(var(--dx), var(--dy)) scale(.6); }
    }
    .fxBadge{
      position: fixed;
      z-index: 2001;
      pointer-events:none;
      transform: translate(-50%, -50%);
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(12,10,14,.62);
      backdrop-filter: var(--glass);
      font-weight: 950;
      letter-spacing: .3px;
      font-size: 12px;
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
      animation: fxBadge .9s ease-out forwards;
      text-shadow: 0 10px 26px rgba(0,0,0,.60);
    }
    @keyframes fxBadge{
      0%{ opacity:0; transform: translate(-50%, -50%) translateY(10px) scale(.96); }
      15%{ opacity:1; transform: translate(-50%, -50%) translateY(0px) scale(1.02); }
      100%{ opacity:0; transform: translate(-50%, -50%) translateY(-26px) scale(1.0); }
    }

    /* ===== tiny idle props ===== */
    .sign{
      position:absolute;
      left: 18px;
      top: 66vh;
      z-index: 58;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(12,10,14,.42);
      backdrop-filter: var(--glass);
      box-shadow: 0 0 0 1px rgba(255,210,120,.08), 0 0 26px rgba(255,210,120,.08);
      font-weight: 950;
      letter-spacing:.3px;
      font-size: 12px;
      animation: signPulse 2.6s ease-in-out infinite;
    }
    .sign span{ opacity:.75; font-weight:800; margin-left:6px; }
    @keyframes signPulse{ 0%,100%{ transform: scale(1); opacity:.92; } 50%{ transform: scale(1.01); opacity:1; } }

  </style>
</head>

<body>
  <div class="world">
    <!-- Cozy illustrated background as one SVG (feels like “real art” even though it’s vector) -->
    <svg class="scene" viewBox="0 0 1400 720" preserveAspectRatio="xMidYMid slice" aria-hidden="true">
      <defs>
        <linearGradient id="skyGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#101a2a"/>
          <stop offset=".55" stop-color="#0b101b"/>
          <stop offset="1" stop-color="#07080c"/>
        </linearGradient>

        <radialGradient id="sunGlow" cx="20%" cy="18%" r="40%">
          <stop offset="0" stop-color="rgba(255,230,170,.30)"/>
          <stop offset=".55" stop-color="rgba(255,230,170,.14)"/>
          <stop offset="1" stop-color="rgba(255,230,170,0)"/>
        </radialGradient>

        <radialGradient id="moonGlow" cx="78%" cy="18%" r="42%">
          <stop offset="0" stop-color="rgba(170,220,255,.22)"/>
          <stop offset=".55" stop-color="rgba(170,220,255,.10)"/>
          <stop offset="1" stop-color="rgba(170,220,255,0)"/>
        </radialGradient>

        <filter id="soft" x="-20%" y="-20%" width="140%" height="140%">
          <feGaussianBlur stdDeviation="1.1"/>
        </filter>

        <linearGradient id="hillBack" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="rgba(85,145,125,.32)"/>
          <stop offset="1" stop-color="rgba(20,40,32,.40)"/>
        </linearGradient>
        <linearGradient id="hillFront" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="rgba(120,200,155,.22)"/>
          <stop offset="1" stop-color="rgba(20,35,28,.46)"/>
        </linearGradient>

        <linearGradient id="townGlow" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="rgba(255,245,220,.10)"/>
          <stop offset="1" stop-color="rgba(255,245,220,0)"/>
        </linearGradient>
      </defs>

      <!-- sky -->
      <rect x="0" y="0" width="1400" height="720" fill="url(#skyGrad)"/>
      <rect x="0" y="0" width="1400" height="420" fill="url(#sunGlow)"/>
      <rect x="0" y="0" width="1400" height="420" fill="url(#moonGlow)"/>

      <!-- stars -->
      <g opacity=".55">
        <circle cx="140" cy="90" r="1.4" fill="rgba(255,255,255,.35)"/>
        <circle cx="240" cy="140" r="1.0" fill="rgba(255,255,255,.28)"/>
        <circle cx="360" cy="80" r="1.2" fill="rgba(255,255,255,.26)"/>
        <circle cx="520" cy="120" r="1.1" fill="rgba(255,255,255,.22)"/>
        <circle cx="690" cy="90" r="1.0" fill="rgba(255,255,255,.24)"/>
        <circle cx="880" cy="130" r="1.2" fill="rgba(255,255,255,.25)"/>
        <circle cx="1010" cy="85" r="1.1" fill="rgba(255,255,255,.22)"/>
        <circle cx="1180" cy="150" r="1.2" fill="rgba(255,255,255,.24)"/>
        <circle cx="1260" cy="90" r="1.0" fill="rgba(255,255,255,.20)"/>
      </g>

      <!-- clouds (soft shapes) -->
      <g opacity=".22" filter="url(#soft)">
        <path d="M140 170c40-28 120-34 160 0 30-20 70-18 94 2 40 34-20 88-110 78-30 22-120 20-160-18-38-35-30-50 16-62z" fill="rgba(255,255,255,.55)"/>
        <path d="M860 160c55-34 150-38 205 3 44-22 92-14 112 12 28 38-28 88-140 76-34 26-126 26-176-10-44-32-34-58 -1-81z" fill="rgba(255,255,255,.45)"/>
      </g>

      <!-- hills back -->
      <path d="M-20 420
               C 120 300, 300 340, 420 410
               C 540 480, 720 470, 860 395
               C 1040 300, 1180 320, 1420 440
               L 1420 720 L -20 720 Z"
            fill="url(#hillBack)" opacity=".95"/>

      <!-- hills front -->
      <path d="M-20 470
               C 110 380, 320 420, 460 500
               C 610 585, 770 560, 930 485
               C 1100 410, 1240 430, 1420 520
               L 1420 720 L -20 720 Z"
            fill="url(#hillFront)" opacity=".95"/>

      <!-- tiny town silhouette -->
      <g opacity=".45">
        <rect x="190" y="460" width="40" height="38" rx="8" fill="rgba(255,255,255,.10)"/>
        <rect x="240" y="444" width="50" height="54" rx="10" fill="rgba(255,255,255,.08)"/>
        <rect x="304" y="470" width="34" height="28" rx="8" fill="rgba(255,255,255,.10)"/>
        <rect x="360" y="452" width="52" height="46" rx="10" fill="rgba(255,255,255,.08)"/>
        <rect x="442" y="470" width="30" height="28" rx="8" fill="rgba(255,255,255,.10)"/>

        <rect x="870" y="460" width="44" height="40" rx="9" fill="rgba(255,255,255,.09)"/>
        <rect x="922" y="444" width="56" height="56" rx="11" fill="rgba(255,255,255,.08)"/>
        <rect x="990" y="470" width="34" height="30" rx="8" fill="rgba(255,255,255,.10)"/>
        <rect x="1042" y="452" width="56" height="48" rx="10" fill="rgba(255,255,255,.08)"/>
        <rect x="1124" y="470" width="30" height="28" rx="8" fill="rgba(255,255,255,.10)"/>

        <rect x="0" y="508" width="1400" height="120" fill="url(#townGlow)"/>
      </g>
    </svg>

    <div class="groundBand"></div>
    <div class="road"></div>

    <div class="sign">EMPIRE REIGNS<span id="sceneNote">starting out</span></div>

    <!-- BUILDINGS -->
    <div class="buildings" aria-label="World buildings">
      <!-- OFFICE (Cozy Cottage Office) -->
      <div class="building b-office" id="bOffice" role="button" tabindex="0" aria-label="Office" data-lvl="1">
        <svg viewBox="0 0 220 190" width="100%" height="100%">
          <!-- soft shadow base -->
          <ellipse cx="112" cy="170" rx="76" ry="12" fill="rgba(0,0,0,.25)"/>
          <!-- roof -->
          <path d="M40 85 L110 35 L182 85 L170 96 L110 55 L52 96 Z"
                fill="rgba(255,210,120,.14)" stroke="rgba(255,245,220,.28)" stroke-width="3" stroke-linejoin="round"/>
          <path d="M56 92 L110 58 L166 92" stroke="rgba(0,0,0,.18)" stroke-width="4" stroke-linecap="round" opacity=".35"/>

          <!-- house body -->
          <rect x="52" y="88" width="116" height="78" rx="20"
                fill="rgba(255,245,220,.08)" stroke="rgba(255,245,220,.26)" stroke-width="3"/>
          <rect x="58" y="94" width="104" height="66" rx="18"
                fill="rgba(0,0,0,.10)" opacity=".55"/>

          <!-- porch -->
          <rect x="70" y="150" width="80" height="16" rx="10"
                fill="rgba(120,180,255,.10)" stroke="rgba(120,180,255,.18)" stroke-width="3"/>

          <!-- door -->
          <rect x="98" y="118" width="28" height="48" rx="12"
                fill="rgba(0,0,0,.25)" stroke="rgba(255,245,220,.22)" stroke-width="3"/>
          <circle cx="121" cy="143" r="2.3" fill="rgba(255,210,120,.35)"/>

          <!-- windows (warm cozy) -->
          <g opacity=".95">
            <rect x="68" y="110" width="28" height="22" rx="10"
                  fill="rgba(120,180,255,.10)" stroke="rgba(120,180,255,.20)" stroke-width="3"/>
            <path d="M82 110 V132" stroke="rgba(255,245,220,.18)" stroke-width="3" opacity=".7"/>
            <path d="M68 121 H96" stroke="rgba(255,245,220,.16)" stroke-width="3" opacity=".7"/>

            <rect x="136" y="110" width="28" height="22" rx="10"
                  fill="rgba(120,180,255,.10)" stroke="rgba(120,180,255,.20)" stroke-width="3"/>
            <path d="M150 110 V132" stroke="rgba(255,245,220,.18)" stroke-width="3" opacity=".7"/>
            <path d="M136 121 H164" stroke="rgba(255,245,220,.16)" stroke-width="3" opacity=".7"/>
          </g>

          <!-- level details -->
          <g class="lvl2" opacity=".95">
            <rect x="64" y="138" width="26" height="18" rx="9"
                  fill="rgba(255,210,120,.10)" stroke="rgba(255,210,120,.18)" stroke-width="3"/>
            <rect x="140" y="138" width="26" height="18" rx="9"
                  fill="rgba(255,210,120,.10)" stroke="rgba(255,210,120,.18)" stroke-width="3"/>
          </g>
          <g class="lvl3" opacity=".95">
            <circle cx="56" cy="132" r="10" fill="rgba(120,220,180,.10)" stroke="rgba(120,220,180,.20)" stroke-width="3"/>
            <path d="M56 125 V139" stroke="rgba(255,245,220,.18)" stroke-width="3"/>
            <path d="M49 132 H63" stroke="rgba(255,245,220,.16)" stroke-width="3"/>
          </g>
          <g class="lvl4" opacity=".95">
            <path d="M74 86 C92 70, 128 70, 146 86" fill="none" stroke="rgba(255,210,120,.20)" stroke-width="4" stroke-linecap="round"/>
            <circle cx="110" cy="72" r="4" fill="rgba(255,210,120,.26)"/>
          </g>

          <!-- sign plaque -->
          <rect x="62" y="78" width="96" height="22" rx="11"
                fill="rgba(12,10,14,.40)" stroke="rgba(255,245,220,.20)" stroke-width="3"/>
          <text x="110" y="93" text-anchor="middle" font-size="10" font-weight="900" fill="rgba(255,245,220,.88)">OFFICE</text>
          <text x="110" y="106" text-anchor="middle" font-size="10" font-weight="900" fill="rgba(255,245,220,.78)" id="officeLvlText">LV1</text>
        </svg>
      </div>

      <!-- WAREHOUSE (Cozy Barn) -->
      <div class="building b-warehouse" id="bWarehouse" role="button" tabindex="0" aria-label="Warehouse" data-lvl="1">
        <svg viewBox="0 0 220 190" width="100%" height="100%">
          <ellipse cx="110" cy="172" rx="84" ry="12" fill="rgba(0,0,0,.25)"/>
          <path d="M56 72 L110 36 L164 72 L164 86 L56 86 Z"
                fill="rgba(255,140,170,.10)" stroke="rgba(255,245,220,.26)" stroke-width="3" stroke-linejoin="round"/>
          <rect x="52" y="84" width="116" height="84" rx="22"
                fill="rgba(255,245,220,.06)" stroke="rgba(255,245,220,.24)" stroke-width="3"/>
          <rect x="64" y="108" width="92" height="60" rx="18"
                fill="rgba(0,0,0,.24)" stroke="rgba(255,245,220,.16)" stroke-width="3"/>
          <path d="M110 108 V168" stroke="rgba(255,245,220,.10)" stroke-width="3"/>
          <g opacity=".9">
            <rect x="70" y="92" width="22" height="16" rx="8"
                  fill="rgba(120,180,255,.10)" stroke="rgba(120,180,255,.20)" stroke-width="3"/>
            <rect x="128" y="92" width="22" height="16" rx="8"
                  fill="rgba(120,180,255,.10)" stroke="rgba(120,180,255,.20)" stroke-width="3"/>
          </g>

          <g class="lvl2" opacity=".95">
            <rect x="42" y="148" width="18" height="14" rx="7" fill="rgba(255,210,120,.10)" stroke="rgba(255,210,120,.18)" stroke-width="3"/>
            <rect x="160" y="148" width="18" height="14" rx="7" fill="rgba(255,210,120,.10)" stroke="rgba(255,210,120,.18)" stroke-width="3"/>
          </g>
          <g class="lvl3" opacity=".95">
            <path d="M40 138 H70" stroke="rgba(120,220,180,.18)" stroke-width="4" stroke-linecap="round"/>
            <circle cx="40" cy="138" r="5" fill="rgba(120,220,180,.18)"/>
          </g>
          <g class="lvl4" opacity=".95">
            <path d="M178 120 C190 110, 196 122, 188 134" fill="none" stroke="rgba(255,210,120,.18)" stroke-width="4" stroke-linecap="round"/>
            <circle cx="188" cy="136" r="5" fill="rgba(255,210,120,.18)"/>
          </g>

          <rect x="62" y="64" width="96" height="22" rx="11"
                fill="rgba(12,10,14,.40)" stroke="rgba(255,245,220,.20)" stroke-width="3"/>
          <text x="110" y="79" text-anchor="middle" font-size="10" font-weight="900" fill="rgba(255,245,220,.88)">WAREHOUSE</text>
          <text x="110" y="92" text-anchor="middle" font-size="10" font-weight="900" fill="rgba(255,245,220,.78)" id="whLvlText">LV1</text>
        </svg>
      </div>

      <!-- GARAGE (Workshop) -->
      <div class="building b-garage" id="bGarage" role="button" tabindex="0" aria-label="Garage" data-lvl="1">
        <svg viewBox="0 0 220 190" width="100%" height="100%">
          <ellipse cx="110" cy="172" rx="84" ry="12" fill="rgba(0,0,0,.25)"/>
          <path d="M54 78 L110 42 L166 78 L154 90 L110 62 L66 90 Z"
                fill="rgba(120,220,180,.10)" stroke="rgba(255,245,220,.26)" stroke-width="3" stroke-linejoin="round"/>
          <rect x="52" y="88" width="116" height="80" rx="22"
                fill="rgba(255,245,220,.06)" stroke="rgba(255,245,220,.24)" stroke-width="3"/>

          <rect x="74" y="110" width="72" height="58" rx="18"
                fill="rgba(0,0,0,.24)" stroke="rgba(255,245,220,.16)" stroke-width="3"/>
          <g opacity=".65">
            <path d="M80 122 H140" stroke="rgba(255,245,220,.10)" stroke-width="3"/>
            <path d="M80 134 H140" stroke="rgba(255,245,220,.10)" stroke-width="3"/>
            <path d="M80 146 H140" stroke="rgba(255,245,220,.10)" stroke-width="3"/>
          </g>

          <circle cx="68" cy="120" r="12" fill="rgba(120,180,255,.10)" stroke="rgba(120,180,255,.20)" stroke-width="3"/>
          <path d="M64 120 L72 128" stroke="rgba(255,245,220,.75)" stroke-width="3" stroke-linecap="round"/>
          <path d="M72 114 L78 120" stroke="rgba(255,245,220,.75)" stroke-width="3" stroke-linecap="round"/>

          <g class="lvl2" opacity=".95">
            <rect x="40" y="148" width="22" height="14" rx="7"
                  fill="rgba(255,210,120,.10)" stroke="rgba(255,210,120,.18)" stroke-width="3"/>
          </g>
          <g class="lvl3" opacity=".95">
            <path d="M170 92 V116" stroke="rgba(255,245,220,.14)" stroke-width="3" stroke-linecap="round"/>
            <circle cx="170" cy="124" r="10" fill="rgba(255,210,120,.12)" stroke="rgba(255,210,120,.20)" stroke-width="3"/>
          </g>
          <g class="lvl4" opacity=".95">
            <path d="M152 68 C162 54, 176 54, 186 68" fill="none" stroke="rgba(255,210,120,.18)" stroke-width="4" stroke-linecap="round"/>
            <circle cx="169" cy="52" r="4" fill="rgba(255,210,120,.20)"/>
          </g>

          <rect x="62" y="80" width="96" height="22" rx="11"
                fill="rgba(12,10,14,.40)" stroke="rgba(255,245,220,.20)" stroke-width="3"/>
          <text x="110" y="95" text-anchor="middle" font-size="10" font-weight="900" fill="rgba(255,245,220,.88)">WORKSHOP</text>
          <text x="110" y="108" text-anchor="middle" font-size="10" font-weight="900" fill="rgba(255,245,220,.78)" id="garLvlText">LV1</text>
        </svg>
      </div>

      <!-- SHOP (Market Stand) -->
      <div class="building b-shop" id="bShop" role="button" tabindex="0" aria-label="Shop" data-lvl="1">
        <svg viewBox="0 0 220 190" width="100%" height="100%">
          <ellipse cx="110" cy="172" rx="84" ry="12" fill="rgba(0,0,0,.25)"/>
          <path d="M58 80 H162 L154 104 H66 Z"
                fill="rgba(255,210,120,.14)" stroke="rgba(255,245,220,.26)" stroke-width="3" stroke-linejoin="round"/>
          <g opacity=".42">
            <path d="M72 80 L68 104" stroke="rgba(0,0,0,.25)" stroke-width="3"/>
            <path d="M92 80 L88 104" stroke="rgba(0,0,0,.25)" stroke-width="3"/>
            <path d="M112 80 L108 104" stroke="rgba(0,0,0,.25)" stroke-width="3"/>
            <path d="M132 80 L128 104" stroke="rgba(0,0,0,.25)" stroke-width="3"/>
            <path d="M152 80 L148 104" stroke="rgba(0,0,0,.25)" stroke-width="3"/>
          </g>

          <rect x="60" y="102" width="104" height="66" rx="22"
                fill="rgba(255,245,220,.06)" stroke="rgba(255,245,220,.24)" stroke-width="3"/>
          <rect x="76" y="120" width="50" height="30" rx="14"
                fill="rgba(120,180,255,.10)" stroke="rgba(120,180,255,.20)" stroke-width="3"/>
          <rect x="134" y="118" width="22" height="50" rx="14"
                fill="rgba(0,0,0,.22)" stroke="rgba(255,245,220,.16)" stroke-width="3"/>
          <circle cx="150" cy="144" r="2.3" fill="rgba(255,210,120,.35)"/>

          <g class="lvl2" opacity=".95">
            <rect x="78" y="112" width="26" height="10" rx="5" fill="rgba(255,210,120,.10)" stroke="rgba(255,210,120,.18)" stroke-width="3"/>
          </g>
          <g class="lvl3" opacity=".95">
            <rect x="168" y="132" width="16" height="22" rx="8" fill="rgba(120,180,255,.10)" stroke="rgba(120,180,255,.18)" stroke-width="3"/>
          </g>
          <g class="lvl4" opacity=".95">
            <rect x="60" y="102" width="104" height="66" rx="22" fill="none" stroke="rgba(255,210,120,.18)" stroke-width="4"/>
          </g>

          <rect x="62" y="64" width="96" height="22" rx="11"
                fill="rgba(12,10,14,.40)" stroke="rgba(255,245,220,.20)" stroke-width="3"/>
          <text x="110" y="79" text-anchor="middle" font-size="10" font-weight="900" fill="rgba(255,245,220,.88)">MARKET</text>
          <text x="110" y="92" text-anchor="middle" font-size="10" font-weight="900" fill="rgba(255,245,220,.78)" id="shopLvlText">LV1</text>
        </svg>
      </div>
    </div>

    <!-- PEOPLE -->
    <div class="people" id="peopleRow" aria-label="People near office"></div>

    <!-- Click catcher -->
    <div class="backdropClickCatcher" id="bubbleCatcher"></div>

    <!-- Speech bubble -->
    <div class="bubble" id="bubble" role="dialog" aria-label="Location panel">
      <div class="bubbleHeader">
        <div>
          <div class="title" id="bubbleTitle">Office</div>
          <div class="small" id="bubbleSubtitle">Hiring & staffing</div>
        </div>
        <button class="bubbleClose" id="bubbleClose">Close</button>
      </div>
      <div class="bubbleBody">
        <div class="bubbleRow">
          <div class="small" id="bubbleDesc">…</div>
          <div class="pill mono" id="bubbleOwned">Owned: 0</div>
        </div>
        <div class="bubbleRow">
          <div class="pill mono" id="bubbleCost">$0</div>
          <button id="bubbleBuyBtn">Buy</button>
        </div>
        <div class="small" id="bubbleLockNote" style="opacity:.85;"></div>
      </div>
    </div>

    <!-- HUD -->
    <div class="hud">
      <div class="hudInner">
        <div class="brand">
          <h1>Empire Reigns</h1>
          <div class="sub" id="status">Ready</div>
        </div>
        <div class="hudStats">
          <div class="pillHud">
            <div class="k">Cash</div>
            <div class="v mono" id="hudCash">$0</div>
          </div>
          <div class="pillHud">
            <div class="k">Income / sec</div>
            <div class="v mono" id="hudIps">$0/s</div>
          </div>
          <div class="pillHud">
            <div class="k">EP</div>
            <div class="v mono" id="hudEp">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- UI Panels -->
    <div class="wrap">
      <div class="panel">
        <div class="tabs">
          <button class="tabBtn active" id="tabWorld">World</button>
          <button class="tabBtn" id="tabUpgrades">Upgrades</button>
          <button class="tabBtn" id="tabPrestige">Prestige</button>
        </div>

        <div class="panelInner">
          <div class="grid">
            <div>
              <div id="screenWorld">
                <div class="item">
                  <div class="itemTop">
                    <div style="font-weight:950;">Actions</div>
                    <div class="pill mono" id="ownedPill">Owned: 0</div>
                  </div>

                  <div class="btnRow" style="margin-top:10px;">
                    <button class="primary canBuy" id="workBtn" style="min-width:170px;">Do Work (+$1)</button>
                    <button id="quickHireBtn" style="min-width:170px;">Hire (Quick)</button>
                  </div>

                  <div class="small" style="margin-top:8px;">
                    Cozy visuals pass: illustrated background + softer UI + warmer palette.
                  </div>

                  <div class="hr"></div>

                  <div class="btnRow">
                    <button id="saveBtn">Save</button>
                    <button id="newRunBtn" title="Resets cash + upgrades, keeps EP">New Run</button>
                    <button class="danger" id="resetBtn" title="Wipes everything including EP">Hard Reset</button>
                  </div>
                </div>

                <div class="item" style="margin-top:12px;">
                  <div class="itemTop">
                    <div style="font-weight:950;">Multipliers</div>
                    <div class="pill mono" id="multSummary">x1.00 total</div>
                  </div>
                  <div class="small mono" id="multDetails" style="margin-top:6px;">Ops x1.00 · Prestige x1.00</div>
                </div>
              </div>

              <div id="screenUpgrades" style="display:none;">
                <div class="itemTop" style="margin-bottom:10px;">
                  <div>
                    <div style="font-weight:950;">Upgrades</div>
                    <div class="small">Unlock in order (1 unlocks next).</div>
                  </div>
                  <div class="pill mono" id="epPill">EP: 0</div>
                </div>

                <div class="item" id="rowAssistant">
                  <div class="itemTop">
                    <div style="font-weight:950;">Hire an Assistant</div>
                    <div class="pill mono" id="assistantCost">$25</div>
                  </div>
                  <div class="small">+ $1.00 base income/sec per purchase. Price grows each time.</div>
                  <button id="buyAssistantBtn">Buy</button>
                </div>

                <div class="item locked" id="rowTools" style="margin-top:10px;">
                  <div class="itemTop">
                    <div style="font-weight:950;">Buy Better Tools</div>
                    <div class="pill mono" id="toolsCost">$60</div>
                  </div>
                  <div class="small">Multiply income by ×1.25 per purchase. Price grows each time.</div>
                  <div class="small" id="toolsLockNote">Unlocks after: 1 assistant</div>
                  <button id="buyToolsBtn" disabled>Locked</button>
                </div>

                <div class="item locked" id="rowProc" style="margin-top:10px;">
                  <div class="itemTop">
                    <div style="font-weight:950;">Standardize Processes</div>
                    <div class="pill mono" id="procCost">$150</div>
                  </div>
                  <div class="small">Multiply income by ×1.40 per purchase. Price grows each time.</div>
                  <div class="small" id="procLockNote">Unlocks after: 1 tools</div>
                  <button id="buyProcBtn" disabled>Locked</button>
                </div>

                <div class="item locked" id="rowAuto" style="margin-top:10px;">
                  <div class="itemTop">
                    <div style="font-weight:950;">Basic Automation</div>
                    <div class="pill mono" id="autoCost">$400</div>
                  </div>
                  <div class="small">Multiply income by ×2.00 per purchase. Price grows each time.</div>
                  <div class="small" id="autoLockNote">Unlocks after: 1 process</div>
                  <button id="buyAutoBtn" disabled>Locked</button>
                </div>
              </div>

              <div id="screenPrestige" style="display:none;">
                <div class="item">
                  <div class="itemTop">
                    <div style="font-weight:950;">Prestige</div>
                    <div class="pill mono" id="prestReq">$10.00K goal</div>
                  </div>
                  <div class="small" id="prestHint" style="margin-top:8px;">Reach the goal to unlock Prestige.</div>
                  <div class="btnRow" style="margin-top:10px;">
                    <button class="gold" id="prestigeBtn" disabled>Prestige (Locked)</button>
                  </div>
                  <div class="hr"></div>
                  <div class="small">Prestige resets your run but increases your permanent multiplier (EP).</div>
                </div>
              </div>
            </div>

            <div>
              <div class="item">
                <div class="itemTop">
                  <div style="font-weight:950;">Stats</div>
                  <div class="pill mono" id="lifetime">$0</div>
                </div>
                <div class="small" style="margin-top:8px;">
                  Lifetime earned (resets on New Run / Prestige): <span class="mono" id="lifetime2">$0</span>
                </div>
                <div class="hr"></div>
                <div class="small mono" id="statsLine">$0/s · Ops x1.00 · Prestige x1.00</div>
              </div>

              <div class="item" style="margin-top:12px;">
                <div class="itemTop">
                  <div style="font-weight:950;">System</div>
                  <div class="pill mono" id="verPill">v2.0</div>
                </div>
                <div class="small" style="margin-top:8px;">
                  Cozy art direction pass done. Next: SFX toggle + juicier feedback.
                </div>
              </div>
            </div>
          </div>

          <div class="padBottom"></div>
        </div>
      </div>
    </div>

    <div class="bottomNav">
      <div class="bottomInner">
        <button class="navBtn active" id="navWorld"><div>World</div><div class="k">Tap + build</div></button>
        <button class="navBtn" id="navUp"><div>Upgrades</div><div class="k">Spend wisely</div></button>
        <button class="navBtn" id="navPr"><div>Prestige</div><div class="k">Reset → grow</div></button>
      </div>
    </div>

    <div class="vignette"></div>
    <div class="grain"></div>
  </div>

  <script>
    const KEY = "empire_reigns_cozy_v2";

    const state = {
      cash: 0,
      lastTickMs: Date.now(),
      lastSaveMs: Date.now(),
      lifetimeEarned: 0,
      ep: 0,
      prestigeCount: 0,
      owned: { assistant: 0, tools: 0, proc: 0, auto: 0 },
      assistantCost: 25,
      toolsCost: 60,
      procCost: 150,
      autoCost: 400
    };

    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function money(n){
      const abs = Math.abs(n);
      if (abs >= 1e9) return "$" + (n/1e9).toFixed(2) + "B";
      if (abs >= 1e6) return "$" + (n/1e6).toFixed(2) + "M";
      if (abs >= 1e3) return "$" + (n/1e3).toFixed(2) + "K";
      return "$" + n.toFixed(2);
    }
    function fmtX(n){ return "x" + n.toFixed(2); }

    function setStatus(msg){
      const el = document.getElementById("status");
      el.textContent = msg;
      clearTimeout(setStatus._t);
      setStatus._t = setTimeout(() => {
        if (el.textContent === msg) el.textContent = "Ready";
      }, 1000);
    }

    function safeMerge(){
      state.owned = Object.assign({assistant:0, tools:0, proc:0, auto:0}, state.owned || {});
      if (typeof state.ep !== "number") state.ep = 0;
      if (typeof state.prestigeCount !== "number") state.prestigeCount = 0;
    }

    function save(silent=false){
      state.lastSaveMs = Date.now();
      localStorage.setItem(KEY, JSON.stringify(state));
      if(!silent) setStatus("Saved");
    }
    function load(){
      const raw = localStorage.getItem(KEY);
      if(!raw) return false;
      try { Object.assign(state, JSON.parse(raw)); safeMerge(); return true; }
      catch { return false; }
    }
    function hardReset(){ localStorage.removeItem(KEY); location.reload(); }

    function opsMultiplier(){
      const toolsMult = Math.pow(1.25, state.owned.tools || 0);
      const procMult  = Math.pow(1.40, state.owned.proc  || 0);
      const autoMult  = Math.pow(2.00, state.owned.auto  || 0);
      return toolsMult * procMult * autoMult;
    }
    function prestigeMultiplier(){ return Math.pow(1.2, state.ep || 0); }
    function baseIncomePerSecond(){ return (state.owned.assistant || 0) * 1.0; }
    function incomePerSecond(){ return baseIncomePerSecond() * opsMultiplier() * prestigeMultiplier(); }

    function unlockedTools(){ return (state.owned.assistant||0) >= 1; }
    function unlockedProc(){  return (state.owned.tools||0) >= 1; }
    function unlockedAuto(){  return (state.owned.proc||0) >= 1; }

    const PRESTIGE_GOAL = 10000;
    function canPrestige(){ return (state.cash||0) >= PRESTIGE_GOAL; }
    function epGainIfPrestigeNow(){
      const le = Math.max(0, state.lifetimeEarned || 0) + 1;
      return Math.max(1, Math.floor(Math.log10(le)));
    }
    function resetRunKeepEP(){
      state.cash = 0;
      state.lastTickMs = Date.now();
      state.lastSaveMs = Date.now();
      state.lifetimeEarned = 0;
      state.owned = { assistant:0, tools:0, proc:0, auto:0 };
      state.assistantCost = 25;
      state.toolsCost = 60;
      state.procCost = 150;
      state.autoCost = 400;
      closeBubble();
      save(true);
      setStatus("New run started");
      render();
    }
    function doPrestige(){
      if(!canPrestige()) return;
      const gain = epGainIfPrestigeNow();
      state.ep = (state.ep||0) + gain;
      state.prestigeCount = (state.prestigeCount||0) + 1;
      resetRunKeepEP();
      setStatus(`Prestiged: +${gain} EP`);
    }

    function applyOfflineProgress(){
      const now = Date.now();
      const secondsAway = (now - (state.lastTickMs || now)) / 1000;
      const capped = clamp(secondsAway, 0, 6*3600);
      const earned = incomePerSecond() * capped;
      if(earned > 0.01){
        state.cash += earned;
        state.lifetimeEarned += earned;
        setStatus(`Offline: +${money(earned)}`);
      } else setStatus("Ready");
      state.lastTickMs = now;
    }

    function floatText(text, x, y){
      const d = document.createElement("div");
      d.className = "floater";
      d.textContent = text;
      d.style.left = x + "px";
      d.style.top = y + "px";
      document.body.appendChild(d);
      setTimeout(() => d.remove(), 650);
    }

    // refs
    const $hudCash = document.getElementById("hudCash");
    const $hudIps = document.getElementById("hudIps");
    const $hudEp = document.getElementById("hudEp");
    const $ownedPill = document.getElementById("ownedPill");
    const $epPill = document.getElementById("epPill");

    const $assistantCost = document.getElementById("assistantCost");
    const $toolsCost = document.getElementById("toolsCost");
    const $procCost = document.getElementById("procCost");
    const $autoCost = document.getElementById("autoCost");

    const $prestigeBtn = document.getElementById("prestigeBtn");
    const $multSummary = document.getElementById("multSummary");
    const $multDetails = document.getElementById("multDetails");
    const $lifetime = document.getElementById("lifetime");
    const $lifetime2 = document.getElementById("lifetime2");
    const $statsLine = document.getElementById("statsLine");
    const $sceneNote = document.getElementById("sceneNote");

    // buildings
    const $bOffice = document.getElementById("bOffice");
    const $bWarehouse = document.getElementById("bWarehouse");
    const $bGarage = document.getElementById("bGarage");
    const $bShop = document.getElementById("bShop");

    const $officeLvlText = document.getElementById("officeLvlText");
    const $whLvlText = document.getElementById("whLvlText");
    const $garLvlText = document.getElementById("garLvlText");
    const $shopLvlText = document.getElementById("shopLvlText");

    // people
    const $peopleRow = document.getElementById("peopleRow");

    // bubble
    const $bubble = document.getElementById("bubble");
    const $bubbleCatcher = document.getElementById("bubbleCatcher");
    const $bubbleClose = document.getElementById("bubbleClose");
    const $bubbleTitle = document.getElementById("bubbleTitle");
    const $bubbleSubtitle = document.getElementById("bubbleSubtitle");
    const $bubbleDesc = document.getElementById("bubbleDesc");
    const $bubbleOwned = document.getElementById("bubbleOwned");
    const $bubbleCost = document.getElementById("bubbleCost");
    const $bubbleBuyBtn = document.getElementById("bubbleBuyBtn");
    const $bubbleLockNote = document.getElementById("bubbleLockNote");

    let bubbleContext = null;
    let bubbleAnchorEl = null;

    function setRow(rowEl, btnEl, noteEl, locked, noteText, canBuy){
      if(locked){
        rowEl.classList.add("locked");
        btnEl.disabled = true;
        btnEl.textContent = "Locked";
        noteEl.textContent = noteText;
        rowEl.classList.remove("canBuy");
      } else {
        rowEl.classList.remove("locked");
        btnEl.disabled = !canBuy;
        btnEl.textContent = canBuy ? "Buy" : "Need more cash";
        noteEl.textContent = noteText;
        rowEl.classList.toggle("canBuy", canBuy);
      }
    }

    function renderPeople(){
      const count = Math.min(12, state.owned.assistant || 0);
      $peopleRow.innerHTML = "";
      for(let i=0;i<count;i++){
        const p = document.createElement("div");
        p.className = "person";
        p.style.transform = `translateY(${(i%3)*2}px)`;
        $peopleRow.appendChild(p);
      }
      if (count > 0){
        const first = $peopleRow.firstElementChild;
        if (first){
          first.style.height = "38px";
          first.style.opacity = "1";
        }
      }
    }

    function positionBubble(){
      if(!bubbleAnchorEl) return;
      const anchor = bubbleAnchorEl.getBoundingClientRect();
      const bubble = $bubble.getBoundingClientRect();
      const padding = 12;

      let left = anchor.left + anchor.width * 0.5 - bubble.width * 0.5;
      left = Math.max(padding, Math.min(window.innerWidth - bubble.width - padding, left));

      let top = anchor.top - bubble.height - 10;
      if (top < 70) top = anchor.bottom + 10;

      $bubble.style.left = left + "px";
      $bubble.style.top = top + "px";

      const anchorCenterX = anchor.left + anchor.width * 0.5;
      const tailX = clamp(anchorCenterX - left, 18, bubble.width - 18);
      $bubble.style.setProperty("--tailX", tailX + "px");
    }

    function openBubble(kind, anchorEl){
      bubbleContext = kind;
      bubbleAnchorEl = anchorEl;
      $bubble.style.display = "block";
      $bubbleCatcher.style.display = "block";
      renderBubbleCurrent();
      requestAnimationFrame(() => positionBubble());
    }

    function closeBubble(){
      $bubble.style.display = "none";
      $bubbleCatcher.style.display = "none";
      bubbleContext = null;
      bubbleAnchorEl = null;
    }

    function renderBubbleCurrent(){
      const cash = state.cash || 0;

      if (bubbleContext === "assistant"){
        $bubbleTitle.textContent = "Office";
        $bubbleSubtitle.textContent = "Hiring & staffing";
        $bubbleDesc.textContent = "Hire assistants to generate steady income per second.";
        $bubbleOwned.textContent = "Owned: " + (state.owned.assistant||0);
        $bubbleCost.textContent = "Cost: " + money(state.assistantCost);
        const can = cash >= state.assistantCost;
        $bubbleBuyBtn.disabled = !can;
        $bubbleBuyBtn.textContent = can ? "Hire Assistant" : "Need more cash";
        $bubbleLockNote.textContent = "Unlock: available immediately.";
      }

      if (bubbleContext === "tools"){
        $bubbleTitle.textContent = "Warehouse";
        $bubbleSubtitle.textContent = "Equipment & output";
        $bubbleDesc.textContent = "Better tools multiply income. Unlocks after hiring 1 assistant.";
        $bubbleOwned.textContent = "Owned: " + (state.owned.tools||0);
        $bubbleCost.textContent = "Cost: " + money(state.toolsCost);
        const unlocked = unlockedTools();
        const can = unlocked && cash >= state.toolsCost;
        $bubbleBuyBtn.disabled = !can;
        $bubbleBuyBtn.textContent = !unlocked ? "Locked" : (can ? "Buy Tools" : "Need more cash");
        $bubbleLockNote.textContent = unlocked ? "Unlocked." : "Locked until: 1 assistant.";
      }

      if (bubbleContext === "proc"){
        $bubbleTitle.textContent = "Workshop";
        $bubbleSubtitle.textContent = "Systems & workflow";
        $bubbleDesc.textContent = "Standardize processes multiply income. Unlocks after buying 1 tools.";
        $bubbleOwned.textContent = "Owned: " + (state.owned.proc||0);
        $bubbleCost.textContent = "Cost: " + money(state.procCost);
        const unlocked = unlockedProc();
        const can = unlocked && cash >= state.procCost;
        $bubbleBuyBtn.disabled = !can;
        $bubbleBuyBtn.textContent = !unlocked ? "Locked" : (can ? "Standardize" : "Need more cash");
        $bubbleLockNote.textContent = unlocked ? "Unlocked." : "Locked until: 1 tools.";
      }

      if (bubbleContext === "auto"){
        $bubbleTitle.textContent = "Market";
        $bubbleSubtitle.textContent = "Automation & scaling";
        $bubbleDesc.textContent = "Automation multiplies income hard. Unlocks after buying 1 process.";
        $bubbleOwned.textContent = "Owned: " + (state.owned.auto||0);
        $bubbleCost.textContent = "Cost: " + money(state.autoCost);
        const unlocked = unlockedAuto();
        const can = unlocked && cash >= state.autoCost;
        $bubbleBuyBtn.disabled = !can;
        $bubbleBuyBtn.textContent = !unlocked ? "Locked" : (can ? "Install Automation" : "Need more cash");
        $bubbleLockNote.textContent = unlocked ? "Unlocked." : "Locked until: 1 process.";
      }
    }

    function bindBuilding(el, kind){
      el.addEventListener("click", () => openBubble(kind, el));
      el.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){ e.preventDefault(); openBubble(kind, el); }
      });
    }
    bindBuilding($bOffice, "assistant");
    bindBuilding($bWarehouse, "tools");
    bindBuilding($bGarage, "proc");
    bindBuilding($bShop, "auto");

    const $rowAssistant = document.getElementById("rowAssistant");
    const $rowTools = document.getElementById("rowTools");
    const $rowProc = document.getElementById("rowProc");
    const $rowAuto = document.getElementById("rowAuto");

    const $buyAssistantBtn = document.getElementById("buyAssistantBtn");
    const $buyToolsBtn = document.getElementById("buyToolsBtn");
    const $buyProcBtn = document.getElementById("buyProcBtn");
    const $buyAutoBtn = document.getElementById("buyAutoBtn");

    const $toolsLockNote = document.getElementById("toolsLockNote");
    const $procLockNote = document.getElementById("procLockNote");
    const $autoLockNote = document.getElementById("autoLockNote");

    // leveling rules
    function levelOffice(assistants){
      if (assistants >= 6) return 4;
      if (assistants >= 3) return 3;
      if (assistants >= 1) return 2;
      return 1;
    }
    function levelGeneric(n){
      if (n >= 3) return 4;
      if (n >= 2) return 3;
      if (n >= 1) return 2;
      return 1;
    }

    // level-up FX
    let lastLevels = null;
    function playLevelUpFx(buildingEl, newLevel){
      const r = buildingEl.getBoundingClientRect();
      const cx = r.left + r.width * 0.55;
      const cy = r.top + r.height * 0.30;

      const badge = document.createElement("div");
      badge.className = "fxBadge";
      badge.textContent = `LV${newLevel}!`;
      badge.style.left = cx + "px";
      badge.style.top = (cy - 8) + "px";
      document.body.appendChild(badge);
      setTimeout(() => badge.remove(), 950);

      const burst = document.createElement("div");
      burst.className = "fxBurst";
      burst.style.left = cx + "px";
      burst.style.top = cy + "px";
      document.body.appendChild(burst);

      const count = 14;
      for(let i=0;i<count;i++){
        const p = document.createElement("div");
        const isBlue = i % 3 === 0;
        p.className = "fxParticle" + (isBlue ? " blue" : "");
        const ang = (Math.PI * 2) * (i / count);
        const mag = 18 + Math.random() * 26;
        const dx = Math.cos(ang) * mag;
        const dy = Math.sin(ang) * mag - (10 + Math.random()*8);
        p.style.setProperty("--dx", dx.toFixed(1) + "px");
        p.style.setProperty("--dy", dy.toFixed(1) + "px");
        p.style.left = "0px";
        p.style.top = "0px";
        burst.appendChild(p);
      }
      setTimeout(() => burst.remove(), 700);
    }

    function renderBuildingLevels(){
      const a = state.owned.assistant || 0;
      const t = state.owned.tools || 0;
      const p = state.owned.proc || 0;
      const x = state.owned.auto || 0;

      const lo = levelOffice(a);
      const lt = levelGeneric(t);
      const lp = levelGeneric(p);
      const lx = levelGeneric(x);

      if (!lastLevels){
        lastLevels = { office: lo, warehouse: lt, garage: lp, shop: lx };
      } else {
        if (lo > lastLevels.office)    playLevelUpFx($bOffice, lo);
        if (lt > lastLevels.warehouse) playLevelUpFx($bWarehouse, lt);
        if (lp > lastLevels.garage)    playLevelUpFx($bGarage, lp);
        if (lx > lastLevels.shop)      playLevelUpFx($bShop, lx);
        lastLevels = { office: lo, warehouse: lt, garage: lp, shop: lx };
      }

      $bOffice.dataset.lvl = String(lo);
      $bWarehouse.dataset.lvl = String(lt);
      $bGarage.dataset.lvl = String(lp);
      $bShop.dataset.lvl = String(lx);

      $officeLvlText.textContent = "LV" + lo;
      $whLvlText.textContent = "LV" + lt;
      $garLvlText.textContent = "LV" + lp;
      $shopLvlText.textContent = "LV" + lx;
    }

    function render(){
      const cash = state.cash||0;
      const ips = incomePerSecond();
      const ep = state.ep||0;

      $hudCash.textContent = money(cash);
      $hudIps.textContent = money(ips) + "/s";
      $hudEp.textContent = String(ep);

      $ownedPill.textContent = "Owned: " + ((state.owned.assistant||0)+(state.owned.tools||0)+(state.owned.proc||0)+(state.owned.auto||0));
      $epPill.textContent = "EP: " + ep;

      $assistantCost.textContent = money(state.assistantCost);
      $toolsCost.textContent = money(state.toolsCost);
      $procCost.textContent = money(state.procCost);
      $autoCost.textContent = money(state.autoCost);

      const canBuyA = cash >= state.assistantCost;
      $buyAssistantBtn.disabled = !canBuyA;
      $buyAssistantBtn.textContent = canBuyA ? "Buy" : "Need more cash";
      $rowAssistant.classList.toggle("canBuy", canBuyA);

      setRow($rowTools, $buyToolsBtn, $toolsLockNote, !unlockedTools(), "Unlocks after: 1 assistant", cash >= state.toolsCost);
      setRow($rowProc,  $buyProcBtn,  $procLockNote,  !unlockedProc(),  "Unlocks after: 1 tools",    cash >= state.procCost);
      setRow($rowAuto,  $buyAutoBtn,  $autoLockNote,  !unlockedAuto(),  "Unlocks after: 1 process",  cash >= state.autoCost);

      document.getElementById("prestReq").textContent = money(PRESTIGE_GOAL) + " goal";
      const ok = canPrestige();
      $prestigeBtn.disabled = !ok;
      $prestigeBtn.textContent = ok ? `Prestige (+${epGainIfPrestigeNow()} EP)` : "Prestige (Locked)";
      document.getElementById("prestHint").textContent = ok ? "Ready. Prestige resets your run but permanently boosts income."
                                                           : `Prestige unlocks at ${money(PRESTIGE_GOAL)} cash.`;

      const ops = opsMultiplier();
      const pm = prestigeMultiplier();
      $multSummary.textContent = fmtX(ops * pm) + " total";
      $multDetails.textContent = `Ops ${fmtX(ops)} · Prestige ${fmtX(pm)}`;

      $lifetime.textContent = money(state.lifetimeEarned||0);
      $lifetime2.textContent = money(state.lifetimeEarned||0);
      $statsLine.textContent = `${money(ips)}/s · Ops ${fmtX(ops)} · Prestige ${fmtX(pm)}`;

      const aa = (state.owned.assistant||0) > 0;
      const tt = (state.owned.tools||0) > 0;
      const pp = (state.owned.proc||0) > 0;
      const xx = (state.owned.auto||0) > 0;
      if (!aa && !tt && !pp && !xx) $sceneNote.textContent = "starting out";
      else if (aa && !tt) $sceneNote.textContent = "hired help";
      else if (tt && !pp) $sceneNote.textContent = "better tools";
      else if (pp && !xx) $sceneNote.textContent = "systems in place";
      else $sceneNote.textContent = "automation online";

      document.getElementById("quickHireBtn").classList.toggle("canBuy", canBuyA);

      $bOffice.classList.toggle("canBuy", canBuyA);
      $bWarehouse.classList.toggle("canBuy", unlockedTools() && cash >= state.toolsCost);
      $bGarage.classList.toggle("canBuy", unlockedProc() && cash >= state.procCost);
      $bShop.classList.toggle("canBuy", unlockedAuto() && cash >= state.autoCost);

      renderPeople();
      renderBuildingLevels();

      if ($bubble.style.display === "block"){
        renderBubbleCurrent();
        positionBubble();
      }
    }

    function tick(){
      const now = Date.now();
      const dt = (now - state.lastTickMs) / 1000;
      state.lastTickMs = now;
      const earned = incomePerSecond() * dt;
      if(earned > 0){
        state.cash += earned;
        state.lifetimeEarned += earned;
      }
      if(now - state.lastSaveMs > 10000) save(true);
      render();
    }

    function tryBuy(cost, onSuccess, event){
      if((state.cash||0) < cost){
        if(event) floatText("Need " + money(cost - state.cash), event.clientX, event.clientY);
        return false;
      }
      state.cash -= cost;
      onSuccess();
      return true;
    }

    // bubble events
    $bubbleClose.addEventListener("click", closeBubble);
    $bubbleCatcher.addEventListener("click", closeBubble);
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && $bubble.style.display === "block") closeBubble();
    });
    window.addEventListener("resize", () => {
      if ($bubble.style.display === "block") positionBubble();
    });

    $bubbleBuyBtn.addEventListener("click", (e) => {
      if(!bubbleContext) return;

      if (bubbleContext === "assistant"){
        const ok = tryBuy(state.assistantCost, () => {
          state.owned.assistant = (state.owned.assistant||0) + 1;
          state.assistantCost = Math.ceil(state.assistantCost * 1.35);
          setStatus("Assistant hired");
        }, e);
        if(ok) render();
        return;
      }

      if (bubbleContext === "tools"){
        if(!unlockedTools()) return;
        const ok = tryBuy(state.toolsCost, () => {
          state.owned.tools = (state.owned.tools||0) + 1;
          state.toolsCost = Math.ceil(state.toolsCost * 1.45);
          setStatus("Tools upgraded");
        }, e);
        if(ok) render();
        return;
      }

      if (bubbleContext === "proc"){
        if(!unlockedProc()) return;
        const ok = tryBuy(state.procCost, () => {
          state.owned.proc = (state.owned.proc||0) + 1;
          state.procCost = Math.ceil(state.procCost * 1.55);
          setStatus("Processes standardized");
        }, e);
        if(ok) render();
        return;
      }

      if (bubbleContext === "auto"){
        if(!unlockedAuto()) return;
        const ok = tryBuy(state.autoCost, () => {
          state.owned.auto = (state.owned.auto||0) + 1;
          state.autoCost = Math.ceil(state.autoCost * 1.70);
          setStatus("Automation installed");
        }, e);
        if(ok) render();
        return;
      }
    });

    // actions
    document.getElementById("workBtn").addEventListener("click", (e) => {
      state.cash += 1; state.lifetimeEarned += 1;
      floatText("+$1", e.clientX, e.clientY);
      render();
    });

    document.getElementById("quickHireBtn").addEventListener("click", (e) => {
      tryBuy(state.assistantCost, () => {
        state.owned.assistant = (state.owned.assistant||0) + 1;
        state.assistantCost = Math.ceil(state.assistantCost * 1.35);
        setStatus("Assistant hired");
      }, e);
      render();
    });

    document.getElementById("saveBtn").addEventListener("click", () => save(false));
    document.getElementById("newRunBtn").addEventListener("click", resetRunKeepEP);
    document.getElementById("resetBtn").addEventListener("click", hardReset);
    document.getElementById("prestigeBtn").addEventListener("click", doPrestige);

    // open bubble from list buttons
    document.getElementById("buyAssistantBtn").addEventListener("click", () => openBubble("assistant", $bOffice));
    document.getElementById("buyToolsBtn").addEventListener("click", () => openBubble("tools", $bWarehouse));
    document.getElementById("buyProcBtn").addEventListener("click", () => openBubble("proc", $bGarage));
    document.getElementById("buyAutoBtn").addEventListener("click", () => openBubble("auto", $bShop));

    // tabs + bottom nav
    const tabWorld = document.getElementById("tabWorld");
    const tabUp = document.getElementById("tabUpgrades");
    const tabPr = document.getElementById("tabPrestige");
    const sWorld = document.getElementById("screenWorld");
    const sUp = document.getElementById("screenUpgrades");
    const sPr = document.getElementById("screenPrestige");

    const navWorld = document.getElementById("navWorld");
    const navUp = document.getElementById("navUp");
    const navPr = document.getElementById("navPr");

    function setActive(which){
      const isW = which === "world";
      const isU = which === "up";
      const isP = which === "pr";

      sWorld.style.display = isW ? "block" : "none";
      sUp.style.display = isU ? "block" : "none";
      sPr.style.display = isP ? "block" : "none";

      tabWorld.classList.toggle("active", isW);
      tabUp.classList.toggle("active", isU);
      tabPr.classList.toggle("active", isP);

      navWorld.classList.toggle("active", isW);
      navUp.classList.toggle("active", isU);
      navPr.classList.toggle("active", isP);

      document.querySelector(".buildings").style.display = isW ? "block" : "none";
      document.getElementById("peopleRow").style.display = isW ? "flex" : "none";
      document.querySelector(".sign").style.display = isW ? "block" : "none";
      if (!isW) closeBubble();
    }

    tabWorld.addEventListener("click", () => setActive("world"));
    tabUp.addEventListener("click", () => setActive("up"));
    tabPr.addEventListener("click", () => setActive("pr"));
    navWorld.addEventListener("click", () => setActive("world"));
    navUp.addEventListener("click", () => setActive("up"));
    navPr.addEventListener("click", () => setActive("pr"));

    // boot
    const hadSave = load();
    safeMerge();
    lastLevels = null;

    applyOfflineProgress();
    render();
    setStatus(hadSave ? "Loaded" : "New run");
    setActive("world");
    setInterval(tick, 100);
  </script>
</body>
</html>

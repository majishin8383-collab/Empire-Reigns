<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compound — Idle Empire</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#070a0f; color:#e8eef7; }

    /* ====== WORLD LAYER (cartoon-ish CSS scene) ====== */
    .world {
      min-height: 100vh;
      position: relative;
      overflow: hidden;
      background:
        radial-gradient(900px 420px at 18% 18%, rgba(255,255,255,.08), transparent 55%),
        linear-gradient(180deg, #0c1320 0%, #0a0f18 18%, #081018 100%);
    }
    .layer { position:absolute; left:0; right:0; }
    .sky {
      top:0; height: 56vh;
      background:
        radial-gradient(260px 220px at 18% 22%, rgba(255,210,120,.26), transparent 60%),
        radial-gradient(140px 140px at 20% 24%, rgba(255,210,120,.22), transparent 62%),
        radial-gradient(900px 360px at 50% 0%, rgba(120,180,255,.16), transparent 62%),
        linear-gradient(180deg, rgba(120,180,255,.06), transparent 50%);
      filter: saturate(1.05);
    }
    .clouds {
      top: 8vh; height: 22vh; opacity:.85;
      background:
        radial-gradient(70px 38px at 18% 50%, rgba(255,255,255,.14), transparent 65%),
        radial-gradient(110px 50px at 22% 54%, rgba(255,255,255,.10), transparent 68%),
        radial-gradient(90px 40px at 55% 44%, rgba(255,255,255,.10), transparent 68%),
        radial-gradient(140px 60px at 60% 50%, rgba(255,255,255,.08), transparent 70%),
        radial-gradient(80px 38px at 78% 48%, rgba(255,255,255,.10), transparent 70%);
      mix-blend-mode: screen;
    }
    .hillsBack {
      top: 30vh; height: 30vh;
      background:
        radial-gradient(520px 220px at 18% 100%, rgba(60,120,95,.38), transparent 70%),
        radial-gradient(600px 260px at 55% 100%, rgba(50,105,90,.36), transparent 70%),
        radial-gradient(520px 220px at 88% 100%, rgba(55,120,95,.34), transparent 70%);
      filter: blur(.2px);
    }
    .hillsFront {
      top: 38vh; height: 30vh;
      background:
        radial-gradient(560px 240px at 22% 100%, rgba(65,155,105,.28), transparent 72%),
        radial-gradient(660px 280px at 60% 100%, rgba(55,140,100,.26), transparent 72%),
        radial-gradient(540px 240px at 92% 100%, rgba(60,150,105,.24), transparent 72%);
    }
    .town {
      top: 54vh; height: 18vh;
      background:
        linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.12)),
        linear-gradient(90deg,
          rgba(255,255,255,.08) 0 6%,
          rgba(255,255,255,.04) 6% 12%,
          rgba(255,255,255,.09) 12% 18%,
          rgba(255,255,255,.05) 18% 26%,
          rgba(255,255,255,.10) 26% 33%,
          rgba(255,255,255,.05) 33% 40%,
          rgba(255,255,255,.09) 40% 48%,
          rgba(255,255,255,.05) 48% 55%,
          rgba(255,255,255,.10) 55% 63%,
          rgba(255,255,255,.05) 63% 72%,
          rgba(255,255,255,.09) 72% 80%,
          rgba(255,255,255,.05) 80% 88%,
          rgba(255,255,255,.10) 88% 100%
        );
      opacity: .55;
      mask-image: linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,1) 30%, rgba(0,0,0,1));
    }
    .ground {
      top: 62vh; bottom: 0;
      background:
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.55)),
        radial-gradient(900px 220px at 50% 0%, rgba(255,255,255,.06), transparent 62%),
        linear-gradient(180deg, rgba(25,60,45,.70), rgba(10,20,15,.95));
    }
    .road {
      position:absolute; left: 50%; transform: translateX(-50%);
      bottom: 18vh;
      width: min(540px, 90vw);
      height: 140px;
      border-radius: 26px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.22)),
        linear-gradient(90deg, rgba(0,0,0,.45), rgba(0,0,0,.25));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 30px 80px rgba(0,0,0,.35);
    }
    .road:before {
      content:"";
      position:absolute; left: 12%; right: 12%; top: 50%;
      height: 6px; transform: translateY(-50%);
      background: repeating-linear-gradient(90deg, rgba(255,210,120,.25) 0 18px, transparent 18px 34px);
      opacity: .7;
      border-radius: 999px;
    }
    .neonSign {
      position:absolute;
      left: 18px; bottom: calc(18vh + 92px);
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      box-shadow: 0 0 0 1px rgba(120,180,255,.18), 0 0 26px rgba(120,180,255,.10);
      font-weight: 900;
      letter-spacing: .3px;
      font-size: 12px;
      z-index: 15;
    }
    .neonSign span { opacity:.75; font-weight:700; margin-left:6px; }

    /* ====== HUD ====== */
    .hud {
      position: sticky; top: 0; z-index: 30;
      background: rgba(7,10,15,.70);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .hudInner {
      max-width: 1120px; margin: 0 auto; padding: 10px 18px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .brand { display:flex; gap:10px; align-items:baseline; }
    .brand h1 { font-size: 16px; margin:0; letter-spacing:.35px; }
    .brand .sub { font-size:12px; opacity:.75; }
    .hudStats { display:flex; gap:10px; flex-wrap:wrap; }
    .hudPill{
      display:flex; flex-direction:column; gap:2px;
      padding: 8px 10px; border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      min-width: 110px;
    }
    .hudPill .k { font-size:10px; opacity:.7; }
    .hudPill .v { font-size:14px; font-weight:900; font-variant-numeric: tabular-nums; }

    /* ====== UI PANELS ====== */
    .wrap{ max-width:1120px; margin:0 auto; padding:18px; position: relative; z-index: 20; }
    .panel {
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      overflow: hidden;
    }
    .panelInner { padding: 14px; }
    .grid { display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 960px){ .grid{ grid-template-columns: 1.2fr .8fr; } }

    .hr{ height:1px; background: rgba(255,255,255,.10); margin: 12px 0; }
    .small{ font-size:12px; opacity:.85; line-height:1.35; }
    .mono{ font-variant-numeric: tabular-nums; }

    /* Buttons */
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:#e8eef7;
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 850;
      transition: transform .06s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      user-select: none;
    }
    button:hover{ background: rgba(255,255,255,.10); }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    button.primary{ background: rgba(120,180,255,.18); border-color: rgba(120,180,255,.35); }
    button.gold{ background: rgba(255,210,120,.14); border-color: rgba(255,210,120,.30); }
    button.danger{ background: rgba(255,100,120,.14); border-color: rgba(255,100,120,.28); }

    .canBuy{
      box-shadow: 0 0 0 1px rgba(120,180,255,.22), 0 0 18px rgba(120,180,255,.12);
      border-color: rgba(120,180,255,.40) !important;
    }

    /* Tabs */
    .tabs {
      display:flex; gap:8px; flex-wrap:wrap;
      padding: 10px;
      background: rgba(255,255,255,.03);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .tabBtn{
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
    }
    .tabBtn.active{
      background: rgba(120,180,255,.18);
      border-color: rgba(120,180,255,.35);
      box-shadow: 0 0 0 1px rgba(120,180,255,.18);
    }

    /* Cards */
    .list{ display:grid; gap:10px; }
    .item{
      display:grid; gap:6px;
      padding: 10px;
      border-radius: 16px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
    }
    .itemTop{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{
      font-size:11px; opacity:.75;
      padding: 4px 8px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .locked{ opacity:.62; filter:saturate(.7); }

    /* Floater */
    .floater{
      position: fixed; pointer-events:none; z-index: 999;
      font-weight: 900; font-size: 12px; opacity: .92;
      transform: translate(-50%, -50%);
      animation: floatUp .55s ease forwards;
      text-shadow: 0 8px 22px rgba(0,0,0,.6);
      font-variant-numeric: tabular-nums;
    }
    @keyframes floatUp{
      from{ opacity:.95; transform: translate(-50%, -50%) translateY(0); }
      to{ opacity:0; transform: translate(-50%, -50%) translateY(-26px); }
    }

    /* Bottom Nav */
    .bottomNav{
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 40;
      background: rgba(7,10,15,.78);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .bottomInner{
      max-width: 1120px; margin: 0 auto; padding: 10px 14px;
      display:flex; gap:10px; justify-content:space-between; align-items:center;
    }
    .navBtn{
      flex:1;
      display:flex; flex-direction:column; gap:2px;
      align-items:center; justify-content:center;
      padding: 10px 8px;
      border-radius: 14px;
      font-size: 12px;
    }
    .navBtn .k{ font-size:10px; opacity:.7; font-weight:800; }
    .navBtn.active{ background: rgba(120,180,255,.16); border-color: rgba(120,180,255,.35); }
    .padBottom{ height: 86px; }

    /* ====== BUILDINGS (SVG hotspots) ====== */
    .buildings {
      position:absolute; left:0; right:0; top:0; bottom:0;
      z-index: 16;
      pointer-events: none;
    }
    .building {
      pointer-events: auto;
      position:absolute;
      width: 160px; height: 130px;
      cursor: pointer;
      user-select: none;
      transform-origin: center bottom;
      transition: transform .08s ease, filter .12s ease;
      filter: drop-shadow(0 14px 18px rgba(0,0,0,.25));
    }
    .building:hover { transform: translateY(-1px) scale(1.01); }
    .building:active { transform: translateY(0px) scale(.99); }

    .b-office    { left: 8vw;  bottom: calc(18vh + 42px); }
    .b-warehouse { left: 30vw; bottom: calc(18vh + 20px); }
    .b-garage    { left: 54vw; bottom: calc(18vh + 24px); }
    .b-shop      { left: 76vw; bottom: calc(18vh + 50px); }

    @media (max-width: 540px){
      .building{ width: 138px; height: 116px; }
      .b-office    { left: 2vw;  }
      .b-warehouse { left: 25vw; }
      .b-garage    { left: 50vw; }
      .b-shop      { left: 72vw; }
    }

    @keyframes glowPulse {
      0% { filter: drop-shadow(0 14px 18px rgba(0,0,0,.25)) drop-shadow(0 0 0 rgba(120,180,255,0)); }
      70% { filter: drop-shadow(0 14px 18px rgba(0,0,0,.25)) drop-shadow(0 0 18px rgba(120,180,255,.18)); }
      100% { filter: drop-shadow(0 14px 18px rgba(0,0,0,.25)) drop-shadow(0 0 0 rgba(120,180,255,0)); }
    }
    .building.canBuy { animation: glowPulse 1.25s ease-in-out infinite; }

    /* ====== PEOPLE (sprites near office) ====== */
    .people {
      position:absolute;
      left: 10vw;
      bottom: calc(18vh + 6px);
      width: 220px;
      height: 70px;
      z-index: 17;
      pointer-events:none;
      display:flex;
      gap: 6px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    @media (max-width:540px){
      .people{ left: 4vw; width: 180px; }
    }
    .person {
      width: 18px; height: 34px;
      border-radius: 999px;
      position: relative;
      opacity: .95;
      filter: drop-shadow(0 8px 10px rgba(0,0,0,.25));
    }
    .person:before{
      content:"";
      position:absolute; left:50%; top:2px;
      width: 14px; height: 14px;
      transform: translateX(-50%);
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.18);
    }
    .person:after{
      content:"";
      position:absolute; left:50%; bottom:0;
      width: 18px; height: 22px;
      transform: translateX(-50%);
      border-radius: 10px;
      background: rgba(120,180,255,.12);
      border: 1px solid rgba(120,180,255,.18);
    }

    /* ====== SPEECH BUBBLE PANEL (anchored) ====== */
    .bubble {
      position:absolute;
      z-index: 50;
      width: min(340px, 86vw);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      display:none;
      overflow:hidden;
    }
    .bubble:after{
      content:"";
      position:absolute;
      width: 14px; height: 14px;
      background: rgba(0,0,0,.55);
      border-left: 1px solid rgba(255,255,255,.14);
      border-bottom: 1px solid rgba(255,255,255,.14);
      transform: rotate(45deg);
      left: var(--tailX, 28px);
      bottom: -7px;
    }
    .bubbleHeader{
      padding: 10px 12px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .bubbleHeader .title{ font-weight: 950; letter-spacing: .2px; }
    .bubbleBody{ padding: 12px; display:grid; gap:10px; }
    .bubbleRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .bubbleClose{
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 950;
    }
    .backdropClickCatcher{
      position:absolute;
      inset:0;
      z-index: 45;
      display:none;
      background: transparent;
    }
  </style>
</head>
<body>
  <div class="world">
    <div class="layer sky"></div>
    <div class="layer clouds"></div>
    <div class="layer hillsBack"></div>
    <div class="layer hillsFront"></div>
    <div class="layer town"></div>

    <div class="layer ground">
      <div class="road"></div>
      <div class="neonSign">COMPOUND<span id="sceneNote">starting out</span></div>
    </div>

    <!-- BUILDINGS -->
    <div class="buildings" aria-label="World buildings">
      <!-- Office -->
      <div class="building b-office" id="bOffice" role="button" tabindex="0" aria-label="Office">
        <svg viewBox="0 0 180 150" width="100%" height="100%">
          <defs>
            <linearGradient id="roofA" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0" stop-color="rgba(255,210,120,.20)"/>
              <stop offset="1" stop-color="rgba(0,0,0,.20)"/>
            </linearGradient>
          </defs>
          <!-- roof -->
          <path d="M18 56 L90 18 L162 56 L152 62 L90 30 L28 62 Z" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.16)" stroke-width="2"/>
          <!-- building -->
          <rect x="26" y="58" width="128" height="78" rx="14" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.16)" stroke-width="2"/>
          <rect x="26" y="58" width="128" height="78" rx="14" fill="url(#roofA)" opacity=".55"/>
          <!-- sign -->
          <rect x="44" y="46" width="92" height="20" rx="10" fill="rgba(120,180,255,.16)" stroke="rgba(120,180,255,.24)" stroke-width="2"/>
          <text x="90" y="60" text-anchor="middle" font-size="10" font-weight="900" fill="rgba(255,255,255,.85)">OFFICE</text>
          <!-- door -->
          <rect x="80" y="86" width="24" height="48" rx="10" fill="rgba(0,0,0,.25)" stroke="rgba(255,255,255,.14)" stroke-width="2"/>
          <circle cx="98" cy="110" r="2" fill="rgba(255,210,120,.35)"/>
          <!-- windows -->
          <g opacity=".9">
            <rect x="44" y="78" width="20" height="16" rx="6" fill="rgba(120,180,255,.14)" stroke="rgba(120,180,255,.20)" stroke-width="2"/>
            <rect x="116" y="78" width="20" height="16" rx="6" fill="rgba(120,180,255,.14)" stroke="rgba(120,180,255,.20)" stroke-width="2"/>
            <rect x="44" y="104" width="20" height="16" rx="6" fill="rgba(120,180,255,.10)" stroke="rgba(120,180,255,.18)" stroke-width="2"/>
            <rect x="116" y="104" width="20" height="16" rx="6" fill="rgba(120,180,255,.10)" stroke="rgba(120,180,255,.18)" stroke-width="2"/>
          </g>
          <!-- base -->
          <rect x="34" y="132" width="112" height="10" rx="6" fill="rgba(0,0,0,.24)" opacity=".65"/>
        </svg>
      </div>

      <!-- Warehouse -->
      <div class="building b-warehouse" id="bWarehouse" role="button" tabindex="0" aria-label="Warehouse">
        <svg viewBox="0 0 180 150" width="100%" height="100%">
          <!-- roof -->
          <rect x="26" y="40" width="128" height="22" rx="12" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.14)" stroke-width="2"/>
          <!-- building -->
          <rect x="22" y="56" width="136" height="84" rx="16" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.14)" stroke-width="2"/>
          <!-- stripes -->
          <g opacity=".55">
            <rect x="30" y="66" width="120" height="10" rx="6" fill="rgba(255,210,120,.10)"/>
            <rect x="30" y="82" width="120" height="10" rx="6" fill="rgba(120,180,255,.10)"/>
          </g>
          <!-- big door -->
          <rect x="58" y="78" width="64" height="60" rx="14" fill="rgba(0,0,0,.22)" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
          <path d="M90 78 V138" stroke="rgba(255,255,255,.10)" stroke-width="2"/>
          <!-- sign -->
          <rect x="40" y="46" width="100" height="18" rx="9" fill="rgba(255,210,120,.14)" stroke="rgba(255,210,120,.22)" stroke-width="2"/>
          <text x="90" y="59" text-anchor="middle" font-size="9" font-weight="900" fill="rgba(255,255,255,.85)">WAREHOUSE</text>
          <!-- pallets -->
          <rect x="28" y="120" width="20" height="16" rx="6" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.10)" stroke-width="2"/>
          <rect x="132" y="120" width="20" height="16" rx="6" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.10)" stroke-width="2"/>
        </svg>
      </div>

      <!-- Garage -->
      <div class="building b-garage" id="bGarage" role="button" tabindex="0" aria-label="Garage">
        <svg viewBox="0 0 180 150" width="100%" height="100%">
          <!-- roof -->
          <path d="M30 62 L90 28 L150 62 L140 70 L90 40 L40 70 Z" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.14)" stroke-width="2"/>
          <!-- building -->
          <rect x="30" y="64" width="120" height="76" rx="16" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.14)" stroke-width="2"/>
          <!-- garage door -->
          <rect x="52" y="86" width="76" height="54" rx="14" fill="rgba(0,0,0,.22)" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
          <g opacity=".7">
            <path d="M56 98 H124" stroke="rgba(255,255,255,.10)" stroke-width="2"/>
            <path d="M56 110 H124" stroke="rgba(255,255,255,.10)" stroke-width="2"/>
            <path d="M56 122 H124" stroke="rgba(255,255,255,.10)" stroke-width="2"/>
          </g>
          <!-- wrench icon -->
          <circle cx="46" cy="96" r="12" fill="rgba(120,180,255,.12)" stroke="rgba(120,180,255,.20)" stroke-width="2"/>
          <path d="M42 96 L50 104" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <path d="M50 90 L56 96" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <!-- sign -->
          <rect x="54" y="52" width="72" height="18" rx="9" fill="rgba(120,180,255,.14)" stroke="rgba(120,180,255,.22)" stroke-width="2"/>
          <text x="90" y="65" text-anchor="middle" font-size="9" font-weight="900" fill="rgba(255,255,255,.85)">GARAGE</text>
        </svg>
      </div>

      <!-- Shop -->
      <div class="building b-shop" id="bShop" role="button" tabindex="0" aria-label="Shop">
        <svg viewBox="0 0 180 150" width="100%" height="100%">
          <!-- awning -->
          <path d="M28 60 H152 L146 80 H34 Z" fill="rgba(255,210,120,.16)" stroke="rgba(255,210,120,.22)" stroke-width="2"/>
          <g opacity=".45">
            <path d="M40 60 L36 80" stroke="rgba(0,0,0,.25)" stroke-width="2"/>
            <path d="M56 60 L52 80" stroke="rgba(0,0,0,.25)" stroke-width="2"/>
            <path d="M72 60 L68 80" stroke="rgba(0,0,0,.25)" stroke-width="2"/>
            <path d="M88 60 L84 80" stroke="rgba(0,0,0,.25)" stroke-width="2"/>
            <path d="M104 60 L100 80" stroke="rgba(0,0,0,.25)" stroke-width="2"/>
            <path d="M120 60 L116 80" stroke="rgba(0,0,0,.25)" stroke-width="2"/>
            <path d="M136 60 L132 80" stroke="rgba(0,0,0,.25)" stroke-width="2"/>
          </g>
          <!-- building -->
          <rect x="30" y="78" width="120" height="62" rx="16" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.14)" stroke-width="2"/>
          <!-- window -->
          <rect x="44" y="92" width="48" height="30" rx="12" fill="rgba(120,180,255,.10)" stroke="rgba(120,180,255,.18)" stroke-width="2"/>
          <!-- door -->
          <rect x="104" y="92" width="32" height="48" rx="12" fill="rgba(0,0,0,.22)" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
          <circle cx="128" cy="118" r="2" fill="rgba(255,210,120,.35)"/>
          <!-- sign -->
          <rect x="52" y="44" width="76" height="20" rx="10" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.14)" stroke-width="2"/>
          <text x="90" y="58" text-anchor="middle" font-size="10" font-weight="900" fill="rgba(255,255,255,.85)">SHOP</text>
        </svg>
      </div>
    </div>

    <!-- PEOPLE -->
    <div class="people" id="peopleRow" aria-label="People near office"></div>

    <!-- Click catcher for bubble (so clicking off closes) -->
    <div class="backdropClickCatcher" id="bubbleCatcher"></div>

    <!-- Speech bubble anchored UI -->
    <div class="bubble" id="bubble" role="dialog" aria-modal="false" aria-label="Location panel">
      <div class="bubbleHeader">
        <div>
          <div class="title" id="bubbleTitle">Office</div>
          <div class="small" id="bubbleSubtitle">Hiring & staffing</div>
        </div>
        <button class="bubbleClose" id="bubbleClose">Close</button>
      </div>
      <div class="bubbleBody">
        <div class="bubbleRow">
          <div class="small" id="bubbleDesc">…</div>
          <div class="pill mono" id="bubbleOwned">Owned: 0</div>
        </div>
        <div class="bubbleRow">
          <div class="pill mono" id="bubbleCost">$0</div>
          <button id="bubbleBuyBtn">Buy</button>
        </div>
        <div class="small" id="bubbleLockNote" style="opacity:.85;"></div>
      </div>
    </div>

    <!-- HUD -->
    <div class="hud">
      <div class="hudInner">
        <div class="brand">
          <h1>Compound</h1>
          <div class="sub" id="status">Ready</div>
        </div>
        <div class="hudStats">
          <div class="hudPill">
            <div class="k">Cash</div>
            <div class="v mono" id="hudCash">$0</div>
          </div>
          <div class="hudPill">
            <div class="k">Income / sec</div>
            <div class="v mono" id="hudIps">$0/s</div>
          </div>
          <div class="hudPill">
            <div class="k">EP</div>
            <div class="v mono" id="hudEp">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- UI Panels -->
    <div class="wrap">
      <div class="panel">
        <div class="tabs">
          <button class="tabBtn active" id="tabWorld">World</button>
          <button class="tabBtn" id="tabUpgrades">Upgrades</button>
          <button class="tabBtn" id="tabPrestige">Prestige</button>
        </div>

        <div class="panelInner">
          <div class="grid">
            <!-- LEFT: main -->
            <div>
              <!-- WORLD SCREEN -->
              <div id="screenWorld">
                <div class="item">
                  <div class="itemTop">
                    <div style="font-weight:900;">Actions</div>
                    <div class="pill mono" id="ownedPill">Owned: 0</div>
                  </div>
                  <div class="btnRow" style="margin-top:10px;">
                    <button class="primary canBuy" id="workBtn" style="min-width:160px;">Do Work (+$1)</button>
                    <button id="quickHireBtn" style="min-width:160px;">Hire (Quick)</button>
                  </div>
                  <div class="small" style="margin-top:8px;">
                    Tap buildings in the world to buy upgrades through an in-world speech bubble.
                  </div>
                  <div class="hr"></div>
                  <div class="btnRow">
                    <button id="saveBtn">Save</button>
                    <button id="newRunBtn" title="Resets cash + upgrades, keeps EP">New Run</button>
                    <button class="danger" id="resetBtn" title="Wipes everything including EP">Hard Reset</button>
                  </div>
                </div>

                <div class="item" style="margin-top:12px;">
                  <div class="itemTop">
                    <div style="font-weight:900;">Multipliers</div>
                    <div class="pill mono" id="multSummary">x1.00 total</div>
                  </div>
                  <div class="small mono" id="multDetails" style="margin-top:6px;">Ops x1.00 · Prestige x1.00</div>
                </div>
              </div>

              <!-- UPGRADES SCREEN -->
              <div id="screenUpgrades" style="display:none;">
                <div class="itemTop" style="margin-bottom:10px;">
                  <div>
                    <div style="font-weight:900;">Upgrades</div>
                    <div class="small">Unlock in order (1 unlocks next).</div>
                  </div>
                  <div class="pill mono" id="epPill">EP: 0</div>
                </div>

                <div class="list">
                  <div class="item" id="rowAssistant">
                    <div class="itemTop">
                      <div style="font-weight:900;">Hire an Assistant</div>
                      <div class="pill mono" id="assistantCost">$25</div>
                    </div>
                    <div class="small">+ $1.00 base income/sec per purchase. Price grows each time.</div>
                    <button id="buyAssistantBtn">Buy</button>
                  </div>

                  <div class="item locked" id="rowTools">
                    <div class="itemTop">
                      <div style="font-weight:900;">Buy Better Tools</div>
                      <div class="pill mono" id="toolsCost">$60</div>
                    </div>
                    <div class="small">Multiply income by ×1.25 per purchase. Price grows each time.</div>
                    <div class="small" id="toolsLockNote">Unlocks after: 1 assistant</div>
                    <button id="buyToolsBtn" disabled>Locked</button>
                  </div>

                  <div class="item locked" id="rowProc">
                    <div class="itemTop">
                      <div style="font-weight:900;">Standardize Processes</div>
                      <div class="pill mono" id="procCost">$150</div>
                    </div>
                    <div class="small">Multiply income by ×1.40 per purchase. Price grows each time.</div>
                    <div class="small" id="procLockNote">Unlocks after: 1 tools</div>
                    <button id="buyProcBtn" disabled>Locked</button>
                  </div>

                  <div class="item locked" id="rowAuto">
                    <div class="itemTop">
                      <div style="font-weight:900;">Basic Automation</div>
                      <div class="pill mono" id="autoCost">$400</div>
                    </div>
                    <div class="small">Multiply income by ×2.00 per purchase. Price grows each time.</div>
                    <div class="small" id="autoLockNote">Unlocks after: 1 process</div>
                    <button id="buyAutoBtn" disabled>Locked</button>
                  </div>
                </div>
              </div>

              <!-- PRESTIGE SCREEN -->
              <div id="screenPrestige" style="display:none;">
                <div class="item">
                  <div class="itemTop">
                    <div style="font-weight:900;">Prestige</div>
                    <div class="pill mono" id="prestReq">$10.00K goal</div>
                  </div>
                  <div class="small" id="prestHint" style="margin-top:8px;">
                    Reach the goal to unlock Prestige.
                  </div>
                  <div class="btnRow" style="margin-top:10px;">
                    <button class="gold" id="prestigeBtn" disabled>Prestige (Locked)</button>
                  </div>
                  <div class="hr"></div>
                  <div class="small">
                    Prestige resets your run but increases your permanent multiplier (EP).
                  </div>
                </div>
              </div>
            </div>

            <!-- RIGHT: stats -->
            <div>
              <div class="item">
                <div class="itemTop">
                  <div style="font-weight:900;">Stats</div>
                  <div class="pill mono" id="lifetime">$0</div>
                </div>
                <div class="small" style="margin-top:8px;">
                  Lifetime earned (resets on New Run / Prestige): <span class="mono" id="lifetime2">$0</span>
                </div>
                <div class="hr"></div>
                <div class="small mono" id="statsLine">$0/s · Ops x1.00 · Prestige x1.00</div>
              </div>

              <div class="item" style="margin-top:12px;">
                <div class="itemTop">
                  <div style="font-weight:900;">System</div>
                  <div class="pill mono" id="verPill">v0.9</div>
                </div>
                <div class="small" style="margin-top:8px;">
                  Buildings + people are now in-world. Next: make buildings visually upgrade (levels) + add animated props.
                </div>
              </div>
            </div>
          </div>

          <div class="padBottom"></div>
        </div>
      </div>
    </div>

    <!-- Bottom Nav -->
    <div class="bottomNav">
      <div class="bottomInner">
        <button class="navBtn active" id="navWorld"><div>World</div><div class="k">Tap + build</div></button>
        <button class="navBtn" id="navUp"><div>Upgrades</div><div class="k">Spend wisely</div></button>
        <button class="navBtn" id="navPr"><div>Prestige</div><div class="k">Reset → grow</div></button>
      </div>
    </div>
  </div>

  <script>
    const KEY = "compound_idle_v0_9";

    const state = {
      cash: 0,
      lastTickMs: Date.now(),
      lastSaveMs: Date.now(),
      lifetimeEarned: 0,
      ep: 0,
      prestigeCount: 0,
      owned: { assistant: 0, tools: 0, proc: 0, auto: 0 },
      assistantCost: 25,
      toolsCost: 60,
      procCost: 150,
      autoCost: 400
    };

    // helpers
    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function money(n){
      const abs = Math.abs(n);
      if (abs >= 1e9) return "$" + (n/1e9).toFixed(2) + "B";
      if (abs >= 1e6) return "$" + (n/1e6).toFixed(2) + "M";
      if (abs >= 1e3) return "$" + (n/1e3).toFixed(2) + "K";
      return "$" + n.toFixed(2);
    }
    function fmtX(n){ return "x" + n.toFixed(2); }

    function setStatus(msg){
      const el = document.getElementById("status");
      el.textContent = msg;
      clearTimeout(setStatus._t);
      setStatus._t = setTimeout(() => {
        if (el.textContent === msg) el.textContent = "Ready";
      }, 1000);
    }

    function safeMerge(){
      state.owned = Object.assign({assistant:0, tools:0, proc:0, auto:0}, state.owned || {});
      if (typeof state.ep !== "number") state.ep = 0;
      if (typeof state.prestigeCount !== "number") state.prestigeCount = 0;
    }

    function save(silent=false){
      state.lastSaveMs = Date.now();
      localStorage.setItem(KEY, JSON.stringify(state));
      if(!silent) setStatus("Saved");
    }
    function load(){
      const raw = localStorage.getItem(KEY);
      if(!raw) return false;
      try { Object.assign(state, JSON.parse(raw)); safeMerge(); return true; }
      catch { return false; }
    }
    function hardReset(){ localStorage.removeItem(KEY); location.reload(); }

    // economics
    function opsMultiplier(){
      const toolsMult = Math.pow(1.25, state.owned.tools || 0);
      const procMult  = Math.pow(1.40, state.owned.proc  || 0);
      const autoMult  = Math.pow(2.00, state.owned.auto  || 0);
      return toolsMult * procMult * autoMult;
    }
    function prestigeMultiplier(){ return Math.pow(1.2, state.ep || 0); }
    function baseIncomePerSecond(){ return (state.owned.assistant || 0) * 1.0; }
    function incomePerSecond(){ return baseIncomePerSecond() * opsMultiplier() * prestigeMultiplier(); }

    // gating (1 unlocks next)
    function unlockedTools(){ return (state.owned.assistant||0) >= 1; }
    function unlockedProc(){  return (state.owned.tools||0) >= 1; }
    function unlockedAuto(){  return (state.owned.proc||0) >= 1; }

    // prestige
    const PRESTIGE_GOAL = 10000;
    function canPrestige(){ return (state.cash||0) >= PRESTIGE_GOAL; }
    function epGainIfPrestigeNow(){
      const le = Math.max(0, state.lifetimeEarned || 0) + 1;
      return Math.max(1, Math.floor(Math.log10(le)));
    }
    function resetRunKeepEP(){
      state.cash = 0;
      state.lastTickMs = Date.now();
      state.lastSaveMs = Date.now();
      state.lifetimeEarned = 0;
      state.owned = { assistant:0, tools:0, proc:0, auto:0 };
      state.assistantCost = 25;
      state.toolsCost = 60;
      state.procCost = 150;
      state.autoCost = 400;
      closeBubble();
      save(true);
      setStatus("New run started");
      render();
    }
    function doPrestige(){
      if(!canPrestige()) return;
      const gain = epGainIfPrestigeNow();
      state.ep = (state.ep||0) + gain;
      state.prestigeCount = (state.prestigeCount||0) + 1;
      resetRunKeepEP();
      setStatus(`Prestiged: +${gain} EP`);
    }

    // offline
    function applyOfflineProgress(){
      const now = Date.now();
      const secondsAway = (now - (state.lastTickMs || now)) / 1000;
      const capped = clamp(secondsAway, 0, 6*3600);
      const earned = incomePerSecond() * capped;
      if(earned > 0.01){
        state.cash += earned;
        state.lifetimeEarned += earned;
        setStatus(`Offline: +${money(earned)}`);
      } else setStatus("Ready");
      state.lastTickMs = now;
    }

    // floater
    function floatText(text, x, y){
      const d = document.createElement("div");
      d.className = "floater";
      d.textContent = text;
      d.style.left = x + "px";
      d.style.top = y + "px";
      document.body.appendChild(d);
      setTimeout(() => d.remove(), 650);
    }

    // refs
    const $hudCash = document.getElementById("hudCash");
    const $hudIps = document.getElementById("hudIps");
    const $hudEp = document.getElementById("hudEp");
    const $ownedPill = document.getElementById("ownedPill");
    const $epPill = document.getElementById("epPill");

    const $assistantCost = document.getElementById("assistantCost");
    const $toolsCost = document.getElementById("toolsCost");
    const $procCost = document.getElementById("procCost");
    const $autoCost = document.getElementById("autoCost");

    const $buyAssistantBtn = document.getElementById("buyAssistantBtn");
    const $buyToolsBtn = document.getElementById("buyToolsBtn");
    const $buyProcBtn = document.getElementById("buyProcBtn");
    const $buyAutoBtn = document.getElementById("buyAutoBtn");

    const $rowAssistant = document.getElementById("rowAssistant");
    const $rowTools = document.getElementById("rowTools");
    const $rowProc = document.getElementById("rowProc");
    const $rowAuto = document.getElementById("rowAuto");

    const $toolsLockNote = document.getElementById("toolsLockNote");
    const $procLockNote = document.getElementById("procLockNote");
    const $autoLockNote = document.getElementById("autoLockNote");

    const $prestigeBtn = document.getElementById("prestigeBtn");
    const $prestReq = document.getElementById("prestReq");
    const $prestHint = document.getElementById("prestHint");

    const $multSummary = document.getElementById("multSummary");
    const $multDetails = document.getElementById("multDetails");
    const $lifetime = document.getElementById("lifetime");
    const $lifetime2 = document.getElementById("lifetime2");
    const $statsLine = document.getElementById("statsLine");

    const $sceneNote = document.getElementById("sceneNote");

    // buildings
    const $bOffice = document.getElementById("bOffice");
    const $bWarehouse = document.getElementById("bWarehouse");
    const $bGarage = document.getElementById("bGarage");
    const $bShop = document.getElementById("bShop");

    // people
    const $peopleRow = document.getElementById("peopleRow");

    // bubble
    const $bubble = document.getElementById("bubble");
    const $bubbleCatcher = document.getElementById("bubbleCatcher");
    const $bubbleClose = document.getElementById("bubbleClose");
    const $bubbleTitle = document.getElementById("bubbleTitle");
    const $bubbleSubtitle = document.getElementById("bubbleSubtitle");
    const $bubbleDesc = document.getElementById("bubbleDesc");
    const $bubbleOwned = document.getElementById("bubbleOwned");
    const $bubbleCost = document.getElementById("bubbleCost");
    const $bubbleBuyBtn = document.getElementById("bubbleBuyBtn");
    const $bubbleLockNote = document.getElementById("bubbleLockNote");

    let bubbleContext = null; // "assistant" | "tools" | "proc" | "auto"
    let bubbleAnchorEl = null;

    function totalOwned(){
      return (state.owned.assistant||0) + (state.owned.tools||0) + (state.owned.proc||0) + (state.owned.auto||0);
    }

    function setRow(rowEl, btnEl, noteEl, locked, noteText, canBuy){
      if(locked){
        rowEl.classList.add("locked");
        btnEl.disabled = true;
        btnEl.textContent = "Locked";
        noteEl.textContent = noteText;
        rowEl.classList.remove("canBuy");
      } else {
        rowEl.classList.remove("locked");
        btnEl.disabled = !canBuy;
        btnEl.textContent = canBuy ? "Buy" : "Need more cash";
        noteEl.textContent = noteText;
        rowEl.classList.toggle("canBuy", canBuy);
      }
    }

    function renderPeople(){
      // show up to 12 assistants as little sprites; first sprite acts like "you"
      const count = Math.min(12, state.owned.assistant || 0);
      $peopleRow.innerHTML = "";
      for(let i=0;i<count;i++){
        const p = document.createElement("div");
        p.className = "person";
        // subtle variation: shift shirt tint using CSS variable via inline style (still theme-consistent)
        const t = 0.10 + (i % 4) * 0.03; // 0.10..0.19
        p.style.setProperty("--t", t);
        // slight stagger height vibe
        p.style.transform = `translateY(${(i%3)*2}px)`;
        $peopleRow.appendChild(p);
      }
      // small tweak: make first person feel like "manager" if exists
      if (count > 0){
        const first = $peopleRow.firstElementChild;
        if (first){
          first.style.height = "36px";
          first.style.opacity = "1";
        }
      }
    }

    function positionBubble(){
      if(!bubbleAnchorEl) return;
      const anchor = bubbleAnchorEl.getBoundingClientRect();
      const bubble = $bubble.getBoundingClientRect();
      const padding = 12;

      // place bubble above the building, centered-ish
      let left = anchor.left + anchor.width * 0.5 - bubble.width * 0.5;
      left = Math.max(padding, Math.min(window.innerWidth - bubble.width - padding, left));

      let top = anchor.top - bubble.height - 10;
      // if not enough room above, place below
      if (top < 70) top = anchor.bottom + 10;

      $bubble.style.left = left + "px";
      $bubble.style.top = top + "px";

      // set tail X toward anchor center
      const anchorCenterX = anchor.left + anchor.width * 0.5;
      const tailX = clamp(anchorCenterX - left, 18, bubble.width - 18);
      $bubble.style.setProperty("--tailX", tailX + "px");
    }

    function openBubble(kind, anchorEl){
      bubbleContext = kind;
      bubbleAnchorEl = anchorEl;
      $bubble.style.display = "block";
      $bubbleCatcher.style.display = "block";
      renderBubbleCurrent();
      // wait a frame for bubble size, then position
      requestAnimationFrame(() => {
        positionBubble();
      });
    }

    function closeBubble(){
      $bubble.style.display = "none";
      $bubbleCatcher.style.display = "none";
      bubbleContext = null;
      bubbleAnchorEl = null;
    }

    function renderBubbleCurrent(){
      const cash = state.cash || 0;

      if (bubbleContext === "assistant"){
        $bubbleTitle.textContent = "Office";
        $bubbleSubtitle.textContent = "Hiring & staffing";
        $bubbleDesc.textContent = "Hire assistants to generate steady income per second.";
        $bubbleOwned.textContent = "Owned: " + (state.owned.assistant||0);
        $bubbleCost.textContent = "Cost: " + money(state.assistantCost);
        const can = cash >= state.assistantCost;
        $bubbleBuyBtn.disabled = !can;
        $bubbleBuyBtn.textContent = can ? "Hire Assistant" : "Need more cash";
        $bubbleLockNote.textContent = "Unlock: available immediately.";
      }

      if (bubbleContext === "tools"){
        $bubbleTitle.textContent = "Warehouse";
        $bubbleSubtitle.textContent = "Equipment & output";
        $bubbleDesc.textContent = "Better tools multiply income. Unlocks after hiring 1 assistant.";
        $bubbleOwned.textContent = "Owned: " + (state.owned.tools||0);
        $bubbleCost.textContent = "Cost: " + money(state.toolsCost);
        const unlocked = unlockedTools();
        const can = unlocked && cash >= state.toolsCost;
        $bubbleBuyBtn.disabled = !can;
        $bubbleBuyBtn.textContent = !unlocked ? "Locked" : (can ? "Buy Tools" : "Need more cash");
        $bubbleLockNote.textContent = unlocked ? "Unlocked." : "Locked until: 1 assistant.";
      }

      if (bubbleContext === "proc"){
        $bubbleTitle.textContent = "Garage";
        $bubbleSubtitle.textContent = "Systems & workflow";
        $bubbleDesc.textContent = "Standardize processes multiply income. Unlocks after buying 1 tools.";
        $bubbleOwned.textContent = "Owned: " + (state.owned.proc||0);
        $bubbleCost.textContent = "Cost: " + money(state.procCost);
        const unlocked = unlockedProc();
        const can = unlocked && cash >= state.procCost;
        $bubbleBuyBtn.disabled = !can;
        $bubbleBuyBtn.textContent = !unlocked ? "Locked" : (can ? "Standardize" : "Need more cash");
        $bubbleLockNote.textContent = unlocked ? "Unlocked." : "Locked until: 1 tools.";
      }

      if (bubbleContext === "auto"){
        $bubbleTitle.textContent = "Shop";
        $bubbleSubtitle.textContent = "Automation & scaling";
        $bubbleDesc.textContent = "Automation multiplies income hard. Unlocks after buying 1 process.";
        $bubbleOwned.textContent = "Owned: " + (state.owned.auto||0);
        $bubbleCost.textContent = "Cost: " + money(state.autoCost);
        const unlocked = unlockedAuto();
        const can = unlocked && cash >= state.autoCost;
        $bubbleBuyBtn.disabled = !can;
        $bubbleBuyBtn.textContent = !unlocked ? "Locked" : (can ? "Install Automation" : "Need more cash");
        $bubbleLockNote.textContent = unlocked ? "Unlocked." : "Locked until: 1 process.";
      }
    }

    function render(){
      const cash = state.cash||0;
      const ips = incomePerSecond();
      const ep = state.ep||0;

      $hudCash.textContent = money(cash);
      $hudIps.textContent = money(ips) + "/s";
      $hudEp.textContent = String(ep);

      $ownedPill.textContent = "Owned: " + totalOwned();
      $epPill.textContent = "EP: " + ep;

      $assistantCost.textContent = money(state.assistantCost);
      $toolsCost.textContent = money(state.toolsCost);
      $procCost.textContent = money(state.procCost);
      $autoCost.textContent = money(state.autoCost);

      // Assistant
      const canBuyA = cash >= state.assistantCost;
      $buyAssistantBtn.disabled = !canBuyA;
      $buyAssistantBtn.textContent = canBuyA ? "Buy" : "Need more cash";
      $rowAssistant.classList.toggle("canBuy", canBuyA);

      // gated
      setRow($rowTools, $buyToolsBtn, $toolsLockNote, !unlockedTools(), "Unlocks after: 1 assistant", cash >= state.toolsCost);
      setRow($rowProc,  $buyProcBtn,  $procLockNote,  !unlockedProc(),  "Unlocks after: 1 tools",    cash >= state.procCost);
      setRow($rowAuto,  $buyAutoBtn,  $autoLockNote,  !unlockedAuto(),  "Unlocks after: 1 process",  cash >= state.autoCost);

      // prestige
      $prestReq.textContent = money(PRESTIGE_GOAL) + " goal";
      const ok = canPrestige();
      $prestigeBtn.disabled = !ok;
      $prestigeBtn.textContent = ok ? `Prestige (+${epGainIfPrestigeNow()} EP)` : "Prestige (Locked)";
      $prestHint.textContent = ok ? "Ready. Prestige resets your run but permanently boosts income."
                                 : `Prestige unlocks at ${money(PRESTIGE_GOAL)} cash.`;

      const ops = opsMultiplier();
      const pm = prestigeMultiplier();
      $multSummary.textContent = fmtX(ops * pm) + " total";
      $multDetails.textContent = `Ops ${fmtX(ops)} · Prestige ${fmtX(pm)}`;

      $lifetime.textContent = money(state.lifetimeEarned||0);
      $lifetime2.textContent = money(state.lifetimeEarned||0);
      $statsLine.textContent = `${money(ips)}/s · Ops ${fmtX(ops)} · Prestige ${fmtX(pm)}`;

      // scene note
      const a = (state.owned.assistant||0) > 0;
      const t = (state.owned.tools||0) > 0;
      const p = (state.owned.proc||0) > 0;
      const x = (state.owned.auto||0) > 0;
      if (!a && !t && !p && !x) $sceneNote.textContent = "starting out";
      else if (a && !t) $sceneNote.textContent = "hired help";
      else if (t && !p) $sceneNote.textContent = "better tools";
      else if (p && !x) $sceneNote.textContent = "systems in place";
      else $sceneNote.textContent = "automation online";

      // quick hire glow
      const q = document.getElementById("quickHireBtn");
      q.classList.toggle("canBuy", canBuyA);

      // building glow states (affordable + unlocked)
      $bOffice.classList.toggle("canBuy", canBuyA);
      $bWarehouse.classList.toggle("canBuy", unlockedTools() && cash >= state.toolsCost);
      $bGarage.classList.toggle("canBuy", unlockedProc() && cash >= state.procCost);
      $bShop.classList.toggle("canBuy", unlockedAuto() && cash >= state.autoCost);

      renderPeople();

      // keep bubble fresh
      if ($bubble.style.display === "block"){
        renderBubbleCurrent();
        positionBubble();
      }
    }

    function tick(){
      const now = Date.now();
      const dt = (now - state.lastTickMs) / 1000;
      state.lastTickMs = now;
      const earned = incomePerSecond() * dt;
      if(earned > 0){
        state.cash += earned;
        state.lifetimeEarned += earned;
      }
      if(now - state.lastSaveMs > 10000) save(true);
      render();
    }

    function tryBuy(cost, onSuccess, event){
      if((state.cash||0) < cost){
        if(event) floatText("Need " + money(cost - state.cash), event.clientX, event.clientY);
        return false;
      }
      state.cash -= cost;
      onSuccess();
      return true;
    }

    // bubble interactions
    $bubbleClose.addEventListener("click", closeBubble);
    $bubbleCatcher.addEventListener("click", closeBubble);
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && $bubble.style.display === "block") closeBubble();
    });
    window.addEventListener("resize", () => {
      if ($bubble.style.display === "block") positionBubble();
    });

    $bubbleBuyBtn.addEventListener("click", (e) => {
      if(!bubbleContext) return;

      if (bubbleContext === "assistant"){
        const ok = tryBuy(state.assistantCost, () => {
          state.owned.assistant = (state.owned.assistant||0) + 1;
          state.assistantCost = Math.ceil(state.assistantCost * 1.35);
          setStatus("Assistant hired");
        }, e);
        if(ok) render();
        return;
      }

      if (bubbleContext === "tools"){
        if(!unlockedTools()) return;
        const ok = tryBuy(state.toolsCost, () => {
          state.owned.tools = (state.owned.tools||0) + 1;
          state.toolsCost = Math.ceil(state.toolsCost * 1.45);
          setStatus("Tools upgraded");
        }, e);
        if(ok) render();
        return;
      }

      if (bubbleContext === "proc"){
        if(!unlockedProc()) return;
        const ok = tryBuy(state.procCost, () => {
          state.owned.proc = (state.owned.proc||0) + 1;
          state.procCost = Math.ceil(state.procCost * 1.55);
          setStatus("Processes standardized");
        }, e);
        if(ok) render();
        return;
      }

      if (bubbleContext === "auto"){
        if(!unlockedAuto()) return;
        const ok = tryBuy(state.autoCost, () => {
          state.owned.auto = (state.owned.auto||0) + 1;
          state.autoCost = Math.ceil(state.autoCost * 1.70);
          setStatus("Automation installed");
        }, e);
        if(ok) render();
        return;
      }
    });

    // building binds
    function bindBuilding(el, kind){
      el.addEventListener("click", () => openBubble(kind, el));
      el.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){ e.preventDefault(); openBubble(kind, el); }
      });
    }
    bindBuilding($bOffice, "assistant");
    bindBuilding($bWarehouse, "tools");
    bindBuilding($bGarage, "proc");
    bindBuilding($bShop, "auto");

    // events
    document.getElementById("workBtn").addEventListener("click", (e) => {
      state.cash += 1; state.lifetimeEarned += 1;
      floatText("+$1", e.clientX, e.clientY);
      render();
    });

    document.getElementById("quickHireBtn").addEventListener("click", (e) => {
      tryBuy(state.assistantCost, () => {
        state.owned.assistant = (state.owned.assistant||0) + 1;
        state.assistantCost = Math.ceil(state.assistantCost * 1.35);
        setStatus("Assistant hired");
      }, e);
      render();
    });

    document.getElementById("saveBtn").addEventListener("click", () => save(false));
    document.getElementById("newRunBtn").addEventListener("click", resetRunKeepEP);
    document.getElementById("resetBtn").addEventListener("click", hardReset);
    document.getElementById("prestigeBtn").addEventListener("click", doPrestige);

    // upgrades tab buttons (kept for debugging + redundancy)
    $buyAssistantBtn.addEventListener("click", (e) => { openBubble("assistant", $bOffice); });
    $buyToolsBtn.addEventListener("click", (e) => { openBubble("tools", $bWarehouse); });
    $buyProcBtn.addEventListener("click", (e) => { openBubble("proc", $bGarage); });
    $buyAutoBtn.addEventListener("click", (e) => { openBubble("auto", $bShop); });

    // tabs + bottom nav
    const tabWorld = document.getElementById("tabWorld");
    const tabUp = document.getElementById("tabUpgrades");
    const tabPr = document.getElementById("tabPrestige");
    const sWorld = document.getElementById("screenWorld");
    const sUp = document.getElementById("screenUpgrades");
    const sPr = document.getElementById("screenPrestige");

    const navWorld = document.getElementById("navWorld");
    const navUp = document.getElementById("navUp");
    const navPr = document.getElementById("navPr");

    function setActive(which){
      const isW = which === "world";
      const isU = which === "up";
      const isP = which === "pr";

      sWorld.style.display = isW ? "block" : "none";
      sUp.style.display = isU ? "block" : "none";
      sPr.style.display = isP ? "block" : "none";

      tabWorld.classList.toggle("active", isW);
      tabUp.classList.toggle("active", isU);
      tabPr.classList.toggle("active", isP);

      navWorld.classList.toggle("active", isW);
      navUp.classList.toggle("active", isU);
      navPr.classList.toggle("active", isP);

      // show buildings+people only on world screen
      document.querySelector(".buildings").style.display = isW ? "block" : "none";
      document.getElementById("peopleRow").style.display = isW ? "flex" : "none";
      if (!isW) closeBubble();
    }

    tabWorld.addEventListener("click", () => setActive("world"));
    tabUp.addEventListener("click", () => setActive("up"));
    tabPr.addEventListener("click", () => setActive("pr"));

    navWorld.addEventListener("click", () => setActive("world"));
    navUp.addEventListener("click", () => setActive("up"));
    navPr.addEventListener("click", () => setActive("pr"));

    // boot
    const hadSave = load();
    safeMerge();
    applyOfflineProgress();
    render();
    setStatus(hadSave ? "Loaded" : "New run");
    setActive("world");
    setInterval(tick, 100);
  </script>
</body>
</html>
